<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üö™ –ö–æ–Ω—Ç—Ä–æ–ª—å –ü—Ä–æ—Ö–æ–¥—É</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --info: #007aff;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #333;
            height: 100%;
            width: 100%;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 390px;
            margin: 0 auto;
            background: #f2f2f7;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        .login-screen {
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .water-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25%;
            background: rgba(255,255,255,0.08);
            border-radius: 50% 50% 0 0;
            animation: wave 6s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-logo {
            font-size: 48px;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .login-title {
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 30px;
            z-index: 10;
        }

        .pin-container {
            background: rgba(255,255,255,0.98);
            border-radius: 20px;
            padding: 24px;
            width: 280px;
            position: relative;
            overflow: hidden;
        }

        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.4) 100%);
            transition: height 0.3s ease;
            height: 0%;
            z-index: 0;
        }

        .pin-display {
            background: #f2f2f7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 28px;
            letter-spacing: 12px;
            font-weight: 700;
            color: #333;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            position: relative;
            z-index: 1;
        }

        .pin-display.error {
            border-color: var(--danger);
            color: var(--danger);
            animation: shake 0.4s;
        }

        .pin-display.success {
            border-color: var(--success);
            color: var(--success);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            75% { transform: translateX(6px); }
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 72px);
            gap: 12px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .pin-btn {
            width: 72px;
            height: 72px;
            border: none;
            border-radius: 50%;
            background: #e5e5ea;
            color: #333;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .pin-btn:active {
            transform: scale(0.92);
            background: #d1d1d6;
        }

        .pin-btn.clear {
            background: var(--danger);
            color: white;
            font-size: 20px;
        }

        .pin-btn.enter {
            background: var(--success);
            color: white;
            font-size: 22px;
        }

        /* Main App - No Scroll */
        .main-app {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f2f2f7;
            height: 100%;
            overflow: hidden;
        }

        /* Compact Header */
        .header {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            color: white;
            padding: 44px 12px 10px;
            flex-shrink: 0;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .header h1 {
            font-size: 17px;
            font-weight: 700;
        }

        .datetime {
            font-size: 13px;
            opacity: 0.9;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .role-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 6px;
            background: rgba(255,255,255,0.3);
            text-transform: uppercase;
            font-weight: 700;
        }

        .add-person-btn {
            position: absolute;
            top: 44px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .add-person-btn:active {
            transform: scale(0.9);
        }

        /* Quick Actions - Single Row */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 8px 12px;
            background: white;
            margin: 6px 12px;
            border-radius: 12px;
            flex-shrink: 0;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px 2px;
            border-radius: 8px;
            cursor: pointer;
            border: 1.5px solid transparent;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.active {
            background: #f0f4ff;
            border-color: var(--primary);
        }

        .action-icon {
            font-size: 22px;
            line-height: 1;
        }

        .action-label {
            font-size: 10px;
            font-weight: 600;
            color: #333;
        }

        /* Stats - Compact */
        .stats-bar {
            display: flex;
            gap: 6px;
            padding: 0 12px 6px;
            flex-shrink: 0;
        }

        .stat-pill {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .stat-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .stat-label {
            font-size: 9px;
            color: #666;
        }

        .stat-num {
            font-size: 14px;
            font-weight: 700;
            color: #333;
        }

        /* Personnel List - Compact Grid */
        .personnel-section {
            flex: 1;
            padding: 0 12px 70px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 11px;
            font-weight: 700;
            color: #8e8e93;
            text-transform: uppercase;
            padding: 6px 4px 4px;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .person-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            overflow-y: auto;
        }

        .person-card {
            background: white;
            border-radius: 10px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .person-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .person-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
            flex-shrink: 0;
        }

        .person-main-info {
            flex: 1;
            min-width: 0;
        }

        .person-name {
            font-weight: 600;
            font-size: 12px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-time {
            font-size: 10px;
            color: #8e8e93;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 600;
            color: white;
        }

        .select-check {
            width: 20px;
            height: 20px;
            border: 1.5px solid #c7c7cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 11px;
            color: white;
        }

        .select-check.selected {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Mini History */
        .mini-history {
            display: flex;
            gap: 6px;
            font-size: 9px;
            color: #666;
            flex-wrap: wrap;
        }

        .mini-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .mini-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 300;
            background: rgba(255,255,255,0.95);
            padding: 6px;
            border-radius: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: #f2f2f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        .tool-btn.primary {
            background: var(--primary);
            color: white;
        }

        /* Modals */
        .sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 400;
        }

        .sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 16px;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 500;
            max-height: 60vh;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: #c7c7cc;
            border-radius: 2px;
            margin: 0 auto 16px;
        }

        .sheet-title {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .status-opt {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .status-opt.selected {
            border-color: var(--primary);
        }

        .status-opt .icon {
            font-size: 24px;
        }

        .sheet-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e5ea;
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 10px;
        }

        .sheet-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        /* Add Person Modal */
        .modal-full {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f2f2f7;
            z-index: 600;
            transform: translateY(100%);
            transition: transform 0.3s;
            overflow-y: auto;
        }

        .modal-full.active {
            transform: translateY(0);
        }

        .modal-header {
            background: white;
            padding: 44px 12px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f2f2f7;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 700;
        }

        .form-section {
            padding: 16px;
            background: white;
            margin-bottom: 8px;
        }

        .form-label {
            font-size: 11px;
            font-weight: 700;
            color: #8e8e93;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e5ea;
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 10px;
        }

        .save-btn {
            width: 100%;
            padding: 14px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        /* Permission */
        .editor-only, .admin-only {
            display: none;
        }

        body[data-role="editor"] .editor-only,
        body[data-role="admin"] .editor-only,
        body[data-role="admin"] .admin-only {
            display: flex;
        }

        body[data-role="reader"] .editor-only,
        body[data-role="reader"] .admin-only,
        body[data-role="reader"] .select-check,
        body[data-role="reader"] .add-person-btn,
        body[data-role="reader"] .bottom-toolbar {
            display: none !important;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Login -->
    <div class="login-screen" id="loginScreen">
        <div class="water-bg"></div>
        <div class="login-logo">üõ°Ô∏è</div>
        <div class="login-title">–ö–æ–Ω—Ç—Ä–æ–ª—å –ü—Ä–æ—Ö–æ–¥—É</div>
        
        <div class="pin-container">
            <div class="water-fill" id="waterFill"></div>
            <div class="pin-display" id="pinDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            
            <div class="pin-keypad">
                <button class="pin-btn" onclick="addPin(1)">1</button>
                <button class="pin-btn" onclick="addPin(2)">2</button>
                <button class="pin-btn" onclick="addPin(3)">3</button>
                <button class="pin-btn" onclick="addPin(4)">4</button>
                <button class="pin-btn" onclick="addPin(5)">5</button>
                <button class="pin-btn" onclick="addPin(6)">6</button>
                <button class="pin-btn" onclick="addPin(7)">7</button>
                <button class="pin-btn" onclick="addPin(8)">8</button>
                <button class="pin-btn" onclick="addPin(9)">9</button>
                <button class="pin-btn clear" onclick="clearPin()">‚å´</button>
                <button class="pin-btn" onclick="addPin(0)">0</button>
                <button class="pin-btn enter" onclick="checkPin()">‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app hidden" id="mainApp">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1>üè¢ –ü—Ä–æ—Ö—ñ–¥–Ω–∞</h1>
                <div class="datetime" id="currentTime">--:--</div>
            </div>
            <div class="user-badge">
                <span id="headerName">--</span>
                <span class="role-badge" id="headerRole">--</span>
            </div>
            <button class="add-person-btn editor-only admin-only" onclick="openAddPerson()">+</button>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="action-btn" onclick="setMyStatus('in', 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ')">
                <span class="action-icon">üè¢</span>
                <span class="action-label">–í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</span>
            </div>
            <div class="action-btn" onclick="setMyStatus('vz', 'üìû –í–ó')">
                <span class="action-icon">üìû</span>
                <span class="action-label">–í–ó</span>
            </div>
            <div class="action-btn" onclick="setMyStatus('rz', 'üìã –†–ó')">
                <span class="action-icon">üìã</span>
                <span class="action-label">–†–ó</span>
            </div>
            <div class="action-btn" onclick="setMyStatus('lunch', 'üçΩÔ∏è –û–±—ñ–¥')">
                <span class="action-icon">üçΩÔ∏è</span>
                <span class="action-label">–û–±—ñ–¥</span>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat-pill">
                <div class="stat-dot" style="background: #333;"></div>
                <span class="stat-label">–í—Å—å–æ–≥–æ</span>
                <span class="stat-num" id="statTotal">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--success);"></div>
                <span class="stat-label">–í –±—É–¥—ñ–≤–ª—ñ</span>
                <span class="stat-num" id="statIn">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--info);"></div>
                <span class="stat-label">–ù–∞ –í–ó</span>
                <span class="stat-num" id="statVz">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--danger);"></div>
                <span class="stat-label">–í—ñ–¥—Å—É—Ç–Ω—ñ</span>
                <span class="stat-num" id="statOut">0</span>
            </div>
        </div>

        <!-- Personnel Grid (2 columns, no scroll needed) -->
        <div class="personnel-section">
            <div class="section-title">
                <span>–ü–µ—Ä—Å–æ–Ω–∞–ª (<span id="personCount">0</span>)</span>
                <span id="selectedCount" style="color: var(--primary);"></span>
            </div>
            <div class="person-grid" id="personGrid"></div>
        </div>
    </div>
</div>

<!-- Bottom Toolbar -->
<div class="bottom-toolbar editor-only admin-only" id="toolbar">
    <button class="tool-btn" onclick="clearSelection()" id="clearBtn">‚úï</button>
    <button class="tool-btn primary" onclick="openBulkSheet()" id="changeBtn">üìù</button>
    <button class="tool-btn" onclick="toggleMenu()">‚ò∞</button>
</div>

<!-- Status Sheet -->
<div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="statusSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheetTitle">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</div>
    
    <div class="status-grid">
        <div class="status-opt" onclick="selectStatus('in', 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ')" style="background: #e8f5e9;">
            <span class="icon">üè¢</span>
            <span>–í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</span>
        </div>
        <div class="status-opt" onclick="selectStatus('vz', 'üìû –í–ó')" style="background: #e3f2fd;">
            <span class="icon">üìû</span>
            <span>–í–ó</span>
        </div>
        <div class="status-opt" onclick="selectStatus('rz', 'üìã –†–ó')" style="background: #fff3e0;">
            <span class="icon">üìã</span>
            <span>–†–ó</span>
        </div>
        <div class="status-opt" onclick="selectStatus('lunch', 'üçΩÔ∏è –û–±—ñ–¥')" style="background: #fce4ec;">
            <span class="icon">üçΩÔ∏è</span>
            <span>–û–±—ñ–¥</span>
        </div>
        <div class="status-opt" onclick="selectStatus('meeting', 'üë• –ù–∞—Ä–∞–¥–∞')" style="background: #f3e5f5;">
            <span class="icon">üë•</span>
            <span>–ù–∞—Ä–∞–¥–∞</span>
        </div>
        <div class="status-opt" onclick="selectStatus('home', 'üè† –î–æ–¥–æ–º—É')" style="background: #ffebee;">
            <span class="icon">üè†</span>
            <span>–î–æ–¥–æ–º—É</span>
        </div>
        <div class="status-opt" onclick="selectStatus('hospital', 'üè• –õ—ñ–∫–∞—Ä–Ω—è')" style="background: #e0f2f1;">
            <span class="icon">üè•</span>
            <span>–õ—ñ–∫–∞—Ä–Ω—è</span>
        </div>
        <div class="status-opt" onclick="selectStatus('trip', '‚úàÔ∏è –í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è')" style="background: #fff8e1;">
            <span class="icon">‚úàÔ∏è</span>
            <span>–í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</span>
        </div>
    </div>

    <input type="text" class="sheet-input" id="sheetCustom" placeholder="–°–≤—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç...">
    <button class="sheet-btn" onclick="applyStatus()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
</div>

<!-- Menu Sheet -->
<div class="sheet-overlay" id="menuOverlay" onclick="closeMenu()"></div>
<div class="bottom-sheet" id="menuSheet">
    <div class="sheet-handle"></div>
    <div style="display: flex; flex-direction: column; gap: 8px;">
        <button class="sheet-btn admin-only" onclick="openAdmin()" style="background: #333;">‚öôÔ∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</button>
        <button class="sheet-btn" onclick="exportData()" style="background: var(--info);">üìä –ï–∫—Å–ø–æ—Ä—Ç</button>
        <button class="sheet-btn" onclick="logout()" style="background: var(--danger);">üö™ –í–∏–π—Ç–∏</button>
    </div>
</div>

<!-- Add Person Modal -->
<div class="modal-full" id="addPersonModal">
    <div class="modal-header">
        <button class="back-btn" onclick="closeAddPerson()">‚Üê</button>
        <div class="modal-title">‚ûï –ù–æ–≤–∏–π —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</div>
    </div>

    <div class="form-section">
        <label class="form-label">–ü–Ü–ë</label>
        <input type="text" class="form-input" id="newPersonName" placeholder="–Ü–≤–∞–Ω–µ–Ω–∫–æ –ü–µ—Ç—Ä–æ –°–∏–¥–æ—Ä–æ–≤–∏—á">
        
        <label class="form-label">PIN (4 —Ü–∏—Ñ—Ä–∏)</label>
        <input type="text" class="form-input" id="newPersonPin" placeholder="1234" maxlength="4">
        
        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
        <div class="status-grid" style="margin-bottom: 16px;">
            <div class="status-opt" onclick="selectNewStatus('in', 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ')" style="background: #e8f5e9;">
                <span class="icon">üè¢</span>
                <span>–í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</span>
            </div>
            <div class="status-opt" onclick="selectNewStatus('vz', 'üìû –í–ó')" style="background: #e3f2fd;">
                <span class="icon">üìû</span>
                <span>–í–ó</span>
            </div>
            <div class="status-opt" onclick="selectNewStatus('rz', 'üìã –†–ó')" style="background: #fff3e0;">
                <span class="icon">üìã</span>
                <span>–†–ó</span>
            </div>
            <div class="status-opt" onclick="selectNewStatus('out', '‚ö™ –ù–µ –Ω–∞ —Ä–æ–±–æ—Ç—ñ')" style="background: #f5f5f5;">
                <span class="icon">‚ö™</span>
                <span>–ù–µ –Ω–∞ —Ä–æ–±–æ—Ç—ñ</span>
            </div>
        </div>
        
        <button class="save-btn" onclick="addNewPerson()">‚úÖ –î–æ–¥–∞—Ç–∏</button>
    </div>
</div>

<!-- Admin Modal -->
<div class="modal-full" id="adminModal">
    <div class="modal-header">
        <button class="back-btn" onclick="closeAdmin()">‚Üê</button>
        <div class="modal-title">‚öôÔ∏è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</div>
    </div>

    <div class="form-section">
        <label class="form-label">–ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á</label>
        <input type="text" class="form-input" id="adminName" placeholder="–ü–Ü–ë">
        <input type="text" class="form-input" id="adminPin" placeholder="PIN" maxlength="4">
        
        <label class="form-label">–†–æ–ª—å</label>
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <button class="role-btn selected" onclick="setRole('editor')" data-role="editor" style="flex:1;padding:10px;border:2px solid var(--primary);border-radius:10px;background:#f0f4ff;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</button>
            <button class="role-btn" onclick="setRole('reader')" data-role="reader" style="flex:1;padding:10px;border:2px solid #e5e5ea;border-radius:10px;">üëÅÔ∏è –ß–∏—Ç–∞—á</button>
        </div>
        
        <button class="save-btn" onclick="addAdminUser()">‚ûï –î–æ–¥–∞—Ç–∏</button>
    </div>

    <div id="adminList"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// Data
let currentUser = null;
let currentPin = '';
let selectedRole = 'editor';
let selectedPersons = new Set();
let sheetTargets = [];
let sheetStatus = null;
let sheetText = '';
let newPersonStatus = 'in';
let newPersonStatusText = 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ';

let users = JSON.parse(localStorage.getItem('users')) || [
    { pin: '1111', name: '–®–µ–≤—á–µ–Ω–∫–æ –û.–ü.', role: 'admin' },
    { pin: '2222', name: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –ú.–Ü.', role: 'editor' },
    { pin: '3333', name: '–ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ –°.–ú.', role: 'reader' },
    { pin: '4444', name: '–¢–∫–∞—á–µ–Ω–∫–æ –ê.–í.', role: 'editor' },
    { pin: '5555', name: '–ú–µ–ª—å–Ω–∏–∫ –í.–û.', role: 'reader' }
];

let personnel = JSON.parse(localStorage.getItem('personnel')) || [
    { id: 1, name: '–®–µ–≤—á–µ–Ω–∫–æ –û.–ü.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', currentSessionStart: new Date(Date.now()-7200000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-7200000).toISOString(),end:null}] },
    { id: 2, name: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –ú.–Ü.', status: 'vz', statusText: 'üìû –í–ó', currentSessionStart: new Date(Date.now()-1800000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-10800000).toISOString(),end:new Date(Date.now()-1800000).toISOString()},{status:'vz',text:'üìû –í–ó',start:new Date(Date.now()-1800000).toISOString(),end:null}] },
    { id: 3, name: '–ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ –°.–ú.', status: 'rz', statusText: 'üìã –†–ó', currentSessionStart: new Date(Date.now()-3600000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-14400000).toISOString(),end:new Date(Date.now()-3600000).toISOString()},{status:'rz',text:'üìã –†–ó',start:new Date(Date.now()-3600000).toISOString(),end:null}] },
    { id: 4, name: '–¢–∫–∞—á–µ–Ω–∫–æ –ê.–í.', status: 'lunch', statusText: 'üçΩÔ∏è –û–±—ñ–¥', currentSessionStart: new Date(Date.now()-2700000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-18000000).toISOString(),end:new Date(Date.now()-2700000).toISOString()},{status:'lunch',text:'üçΩÔ∏è –û–±—ñ–¥',start:new Date(Date.now()-2700000).toISOString(),end:null}] },
    { id: 5, name: '–ú–µ–ª—å–Ω–∏–∫ –í.–û.', status: 'meeting', statusText: 'üë• –ù–∞—Ä–∞–¥–∞', currentSessionStart: new Date(Date.now()-5400000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-9000000).toISOString(),end:new Date(Date.now()-5400000).toISOString()},{status:'meeting',text:'üë• –ù–∞—Ä–∞–¥–∞',start:new Date(Date.now()-5400000).toISOString(),end:null}] },
    { id: 6, name: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –Ü.–î.', status: 'home', statusText: 'üè† –î–æ–¥–æ–º—É', currentSessionStart: new Date(Date.now()-86400000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-172800000).toISOString(),end:new Date(Date.now()-86400000).toISOString()},{status:'home',text:'üè† –î–æ–¥–æ–º—É',start:new Date(Date.now()-86400000).toISOString(),end:null}] },
    { id: 7, name: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –ù.–ü.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', currentSessionStart: new Date(Date.now()-14400000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-14400000).toISOString(),end:null}] },
    { id: 8, name: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –û.–í.', status: 'vz', statusText: 'üìû –í–ó', currentSessionStart: new Date(Date.now()-4500000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-21600000).toISOString(),end:new Date(Date.now()-7200000).toISOString()},{status:'rz',text:'üìã –†–ó',start:new Date(Date.now()-7200000).toISOString(),end:new Date(Date.now()-4500000).toISOString()},{status:'vz',text:'üìû –í–ó',start:new Date(Date.now()-4500000).toISOString(),end:null}] },
    { id: 9, name: '–õ–∏—Å–µ–Ω–∫–æ –û.–ú.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', currentSessionStart: new Date(Date.now()-10800000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-10800000).toISOString(),end:null}] },
    { id: 10, name: '–ú–æ—Ä–æ–∑–æ–≤ –î.–°.', status: 'rz', statusText: 'üìã –†–ó', currentSessionStart: new Date(Date.now()-5400000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-12600000).toISOString(),end:new Date(Date.now()-5400000).toISOString()},{status:'rz',text:'üìã –†–ó',start:new Date(Date.now()-5400000).toISOString(),end:null}] },
    { id: 11, name: '–í–∞—Å–∏–ª—å—î–≤–∞ –Ü.–ü.', status: 'lunch', statusText: 'üçΩÔ∏è –û–±—ñ–¥', currentSessionStart: new Date(Date.now()-1800000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-9000000).toISOString(),end:new Date(Date.now()-1800000).toISOString()},{status:'lunch',text:'üçΩÔ∏è –û–±—ñ–¥',start:new Date(Date.now()-1800000).toISOString(),end:null}] }
];

// Clock
function updateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('uk-UA', {hour:'2-digit',minute:'2-digit'});
}
setInterval(updateTime, 1000);
updateTime();

// PIN
function addPin(num) {
    if (currentPin.length < 4) {
        currentPin += num;
        updatePin();
        document.getElementById('waterFill').style.height = (currentPin.length / 4 * 100) + '%';
    }
}

function clearPin() {
    currentPin = currentPin.slice(0, -1);
    updatePin();
    document.getElementById('waterFill').style.height = (currentPin.length / 4 * 100) + '%';
    document.getElementById('pinDisplay').classList.remove('error');
}

function updatePin() {
    document.getElementById('pinDisplay').textContent = currentPin.length === 0 ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '‚Ä¢'.repeat(currentPin.length) + '‚Ä¢'.repeat(4 - currentPin.length);
}

function checkPin() {
    if (currentPin.length !== 4) return;
    
    const user = users.find(u => u.pin === currentPin);
    if (user) {
        document.getElementById('pinDisplay').classList.add('success');
        document.getElementById('waterFill').style.height = '100%';
        
        setTimeout(() => {
            currentUser = user;
            document.body.setAttribute('data-role', user.role);
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('headerName').textContent = user.name.split(' ')[0];
            document.getElementById('headerRole').textContent = user.role;
            
            if (!personnel.find(p => p.name === user.name)) {
                personnel.push({
                    id: Date.now(),
                    name: user.name,
                    status: 'in',
                    statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',
                    currentSessionStart: new Date().toISOString(),
                    history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date().toISOString(),end:null}]
                });
                saveData();
            }
            
            renderGrid();
            updateStats();
            updateQuick();
            
            currentPin = '';
            updatePin();
            document.getElementById('waterFill').style.height = '0%';
            document.getElementById('pinDisplay').classList.remove('success');
            showToast(`–í—ñ—Ç–∞—î–º–æ!`);
        }, 400);
    } else {
        document.getElementById('pinDisplay').classList.add('error');
        setTimeout(() => {
            currentPin = '';
            updatePin();
            document.getElementById('pinDisplay').classList.remove('error');
            document.getElementById('waterFill').style.height = '0%';
        }, 600);
    }
}

// Status
function setMyStatus(status, text) {
    if (currentUser.role === 'reader') {
        showToast('‚õî –¢—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥');
        return;
    }
    const person = personnel.find(p => p.name === currentUser.name);
    if (person) {
        changeStatus(person, status, text);
        updateQuick();
        showToast(`‚úÖ ${text.split(' ')[0]}`);
    }
}

function changeStatus(person, status, text) {
    const now = new Date().toISOString();
    if (person.history.length && !person.history[person.history.length-1].end) {
        person.history[person.history.length-1].end = now;
    }
    person.status = status;
    person.statusText = text;
    person.currentSessionStart = now;
    person.history.push({status, text, start: now, end: null});
    if (person.history.length > 3) person.history = person.history.slice(-3);
    saveData();
    renderGrid();
    updateStats();
}

// Render Grid (2 columns, compact)
function renderGrid() {
    const container = document.getElementById('personGrid');
    container.innerHTML = '';
    
    // Limit to 8 visible to fit screen
    const visible = personnel.slice(0, 8);
    document.getElementById('personCount').textContent = personnel.length;
    
    visible.forEach(p => {
        const isSel = selectedPersons.has(p.id);
        const last = p.history[p.history.length-1];
        const dur = last ? calcDur(last.start, last.end || new Date().toISOString()) : '';
        
        const card = document.createElement('div');
        card.className = 'person-card';
        card.onclick = (e) => onCardClick(p.id, e);
        
        card.innerHTML = `
            <div class="person-header">
                <div class="person-avatar">${p.name[0]}</div>
                <div class="person-main-info">
                    <div class="person-name">${p.name}</div>
                    <div class="person-time">${dur}</div>
                </div>
                ${currentUser && currentUser.role !== 'reader' ? `
                <div class="select-check ${isSel ? 'selected' : ''}" onclick="toggleSelect(${p.id}, event)">
                    ${isSel ? '‚úì' : ''}
                </div>` : ''}
            </div>
            <span class="status-badge" style="background:${getColor(p.status)};align-self:flex-start;">${p.statusText}</span>
        `;
        container.appendChild(card);
    });
}

function getColor(s) {
    const c = {in:'#34c759', vz:'#007aff', rz:'#ff9500', lunch:'#ff9500', meeting:'#af52de', home:'#ff3b30', out:'#999'};
    return c[s] || '#999';
}

function calcDur(a, b) {
    const d = new Date(b) - new Date(a);
    const h = Math.floor(d/3600000), m = Math.floor((d%3600000)/60000);
    if (h > 0) return `${h}–≥ ${m}—Ö–≤`;
    return `${m}—Ö–≤`;
}

function onCardClick(id, e) {
    if (e.target.closest('.select-check')) return;
    if (currentUser.role === 'reader') return;
    openSheet([id]);
}

function toggleSelect(id, e) {
    e.stopPropagation();
    selectedPersons.has(id) ? selectedPersons.delete(id) : selectedPersons.add(id);
    updateSelUI();
    renderGrid();
}

function updateSelUI() {
    const n = selectedPersons.size;
    document.getElementById('selectedCount').textContent = n ? `${n} –≤–∏–±—Ä–∞–Ω–æ` : '';
    document.getElementById('clearBtn').style.display = n ? 'flex' : 'none';
    document.getElementById('changeBtn').style.display = n ? 'flex' : 'none';
}

function clearSelection() {
    selectedPersons.clear();
    updateSelUI();
    renderGrid();
}

function updateStats() {
    document.getElementById('statTotal').textContent = personnel.length;
    document.getElementById('statIn').textContent = personnel.filter(p => p.status === 'in').length;
    document.getElementById('statVz').textContent = personnel.filter(p => p.status === 'vz').length;
    document.getElementById('statOut').textContent = personnel.filter(p => ['home','out'].includes(p.status)).length;
}

function updateQuick() {
    const p = personnel.find(x => x.name === currentUser?.name);
    if (!p) return;
    document.querySelectorAll('.action-btn').forEach((b, i) => {
        b.classList.toggle('active', ['in','vz','rz','lunch'][i] === p.status);
    });
}

// Sheets
function openSheet(ids) {
    sheetTargets = ids;
    document.getElementById('sheetTitle').textContent = ids.length === 1 ? '–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å' : `–ó–º—ñ–Ω–∏—Ç–∏ (${ids.length})`;
    document.getElementById('sheetOverlay').classList.add('active');
    document.getElementById('statusSheet').classList.add('active');
    document.querySelectorAll('#statusSheet .status-opt').forEach(el => el.classList.remove('selected'));
    document.getElementById('sheetCustom').value = '';
    sheetStatus = null;
}

function openBulkSheet() {
    openSheet(Array.from(selectedPersons));
}

function closeSheet() {
    document.getElementById('sheetOverlay').classList.remove('active');
    document.getElementById('statusSheet').classList.remove('active');
}

function selectStatus(st, txt) {
    document.querySelectorAll('#statusSheet .status-opt').forEach(el => el.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    sheetStatus = st;
    sheetText = txt;
    document.getElementById('sheetCustom').value = '';
}

function applyStatus() {
    const cst = document.getElementById('sheetCustom').value.trim();
    const st = cst ? 'custom' : sheetStatus;
    const txt = cst || sheetText;
    if (!st) { showToast('‚õî –û–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—É—Å'); return; }
    
    sheetTargets.forEach(id => {
        const p = personnel.find(x => x.id === id);
        if (p) changeStatus(p, st, txt);
    });
    
    showToast(`‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ!`);
    closeSheet();
    clearSelection();
}

function toggleMenu() {
    document.getElementById('menuOverlay').classList.add('active');
    document.getElementById('menuSheet').classList.add('active');
}

function closeMenu() {
    document.getElementById('menuOverlay').classList.remove('active');
    document.getElementById('menuSheet').classList.remove('active');
}

// Add Person
function openAddPerson() {
    document.getElementById('addPersonModal').classList.add('active');
    document.getElementById('newPersonName').value = '';
    document.getElementById('newPersonPin').value = '';
    newPersonStatus = 'in';
    newPersonStatusText = 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ';
    document.querySelectorAll('#addPersonModal .status-opt').forEach(el => el.classList.remove('selected'));
}

function closeAddPerson() {
    document.getElementById('addPersonModal').classList.remove('active');
}

function selectNewStatus(st, txt) {
    document.querySelectorAll('#addPersonModal .status-opt').forEach(el => el.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    newPersonStatus = st;
    newPersonStatusText = txt;
}

function addNewPerson() {
    const name = document.getElementById('newPersonName').value.trim();
    const pin = document.getElementById('newPersonPin').value.trim();
    
    if (!name || pin.length !== 4) {
        showToast('‚õî –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
        return;
    }
    
    if (users.find(u => u.pin === pin)) {
        showToast('‚õî PIN –∑–∞–π–Ω—è—Ç–∏–π');
        return;
    }
    
    const now = new Date().toISOString();
    
    personnel.push({
        id: Date.now(),
        name: name,
        status: newPersonStatus,
        statusText: newPersonStatusText,
        currentSessionStart: now,
        history: [{status: newPersonStatus, text: newPersonStatusText, start: now, end: null}]
    });
    
    users.push({pin: pin, name: name, role: 'reader'});
    
    saveData();
    renderGrid();
    updateStats();
    closeAddPerson();
    showToast(`‚úÖ –î–æ–¥–∞–Ω–æ!`);
}

// Admin
function openAdmin() {
    closeMenu();
    document.getElementById('adminModal').classList.add('active');
    renderAdminList();
}

function closeAdmin() {
    document.getElementById('adminModal').classList.remove('active');
}

function setRole(r) {
    selectedRole = r;
    document.querySelectorAll('.role-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.style.borderColor = '#e5e5ea';
        btn.style.background = 'white';
    });
    const btn = document.querySelector(`[data-role="${r}"]`);
    btn.classList.add('selected');
    btn.style.borderColor = 'var(--primary)';
    btn.style.background = '#f0f4ff';
}

function addAdminUser() {
    const n = document.getElementById('adminName').value.trim();
    const p = document.getElementById('adminPin').value.trim();
    if (!n || p.length !== 4) { showToast('‚õî –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è'); return; }
    if (users.find(u => u.pin === p)) { showToast('‚õî PIN –∑–∞–π–Ω—è—Ç–∏–π'); return; }
    
    users.push({pin:p, name:n, role:selectedRole});
    saveData();
    document.getElementById('adminName').value = '';
    document.getElementById('adminPin').value = '';
    renderAdminList();
    showToast('‚úÖ –î–æ–¥–∞–Ω–æ!');
}

function renderAdminList() {
    const c = document.getElementById('adminList');
    c.innerHTML = '<div style="padding:0 16px;font-size:11px;color:#8e8e93;text-transform:uppercase;margin-bottom:8px;">–°–ø–∏—Å–æ–∫</div>';
    users.forEach(u => {
        const d = document.createElement('div');
        d.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:white;border-bottom:1px solid #f0f0f0;';
        d.innerHTML = `
            <div>
                <div style="font-weight:600;font-size:14px;">${u.name}</div>
                <div style="font-size:12px;color:#8e8e93;">PIN: ${u.pin}</div>
            </div>
            <span style="font-size:10px;padding:4px 10px;border-radius:10px;background:${u.role==='admin'?'#ffebee;color:#e74c3c':u.role==='editor'?'#e3f2fd;color:#007aff':'#f2f2f7;color:#666'};font-weight:600;text-transform:uppercase;">${u.role}</span>
        `;
        c.appendChild(d);
    });
}

function exportData() {
    closeMenu();
    let csv = '–ü–Ü–ë,–°—Ç–∞—Ç—É—Å\n';
    personnel.forEach(p => {
        csv += `"${p.name}","${p.statusText}"\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `–ø—Ä–æ—Ö–æ–¥_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    showToast('üìä –ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
}

function saveData() {
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('personnel', JSON.stringify(personnel));
}

function logout() {
    closeMenu();
    currentUser = null;
    selectedPersons.clear();
    document.body.removeAttribute('data-role');
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    currentPin = '';
    updatePin();
    document.getElementById('waterFill').style.height = '0%';
}

function showToast(m) {
    const t = document.getElementById('toast');
    t.textContent = m;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

// Init
renderGrid();
updateStats();
</script>

</body>
</html>
