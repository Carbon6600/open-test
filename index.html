<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üö™ –ö–æ–Ω—Ç—Ä–æ–ª—å –ü—Ä–æ—Ö–æ–¥—É</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --info: #007aff;
            --bg: #f2f2f7;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #333;
            height: 100%;
            width: 100%;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 430px;
            margin: 0 auto;
            background: var(--bg);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        .login-screen {
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .water-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25%;
            background: rgba(255,255,255,0.08);
            border-radius: 50% 50% 0 0;
            animation: wave 6s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-logo {
            font-size: 56px;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .login-title {
            color: white;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 30px;
            z-index: 10;
            text-align: center;
        }

        .pin-container {
            background: rgba(255,255,255,0.98);
            border-radius: 24px;
            padding: 28px;
            width: 300px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.5) 100%);
            transition: height 0.3s ease;
            height: 0%;
            z-index: 0;
        }

        .pin-display {
            background: #f2f2f7;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
            font-size: 32px;
            letter-spacing: 16px;
            font-weight: 700;
            color: #333;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid transparent;
            position: relative;
            z-index: 1;
        }

        .pin-display.error {
            border-color: var(--danger);
            color: var(--danger);
            animation: shake 0.4s;
        }

        .pin-display.success {
            border-color: var(--success);
            color: var(--success);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .pin-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 50%;
            background: #e5e5ea;
            color: #333;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .pin-btn:active {
            transform: scale(0.92);
            background: #d1d1d6;
        }

        .pin-btn.clear {
            background: var(--danger);
            color: white;
            font-size: 20px;
        }

        .pin-btn.enter {
            background: var(--success);
            color: white;
            font-size: 24px;
        }

        /* Main App */
        .main-app {
            flex: 1;
            display: none;
            flex-direction: column;
            background: var(--bg);
            height: 100%;
            overflow: hidden;
        }

        .main-app.active {
            display: flex;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            color: white;
            padding: 50px 16px 12px;
            flex-shrink: 0;
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .datetime {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .role-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.25);
            text-transform: uppercase;
            font-weight: 700;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: white;
            margin: 8px 12px 0;
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            padding: 8px 12px;
            background: white;
            margin: 8px 12px;
            border-radius: 16px;
            flex-shrink: 0;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 2px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.active {
            background: #f0f4ff;
            border-color: var(--primary);
        }

        .action-icon {
            font-size: 24px;
            line-height: 1;
        }

        .action-label {
            font-size: 10px;
            font-weight: 600;
            color: #333;
            text-align: center;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 8px;
            padding: 0 12px 8px;
            flex-shrink: 0;
        }

        .stat-pill {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .stat-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stat-label {
            font-size: 9px;
            color: #666;
            font-weight: 500;
        }

        .stat-num {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 0 12px 80px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
        }

        .tab-content.active {
            opacity: 1;
            visibility: visible;
        }

        /* Personnel Section */
        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: #8e8e93;
            text-transform: uppercase;
            padding: 12px 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-hint {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .selection-hint.visible {
            opacity: 1;
        }

        .person-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .person-card {
            background: white;
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .person-card:active {
            transform: scale(0.98);
        }

        .person-card.selected {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .person-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .person-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .person-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .person-info {
            flex: 1;
            min-width: 0;
        }

        .person-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-time {
            font-size: 11px;
            color: #8e8e93;
            font-weight: 500;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            align-self: flex-start;
        }

        /* Statistics Tab */
        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #333;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            gap: 8px;
            padding: 0 8px;
        }

        .chart-bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .chart-bar {
            width: 100%;
            max-width: 40px;
            border-radius: 8px 8px 0 0;
            transition: height 0.5s ease;
            position: relative;
            min-height: 4px;
        }

        .chart-bar-label {
            font-size: 10px;
            color: #666;
            font-weight: 600;
            text-align: center;
        }

        .chart-value {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 700;
            color: #333;
        }

        .timeline-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-time {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            min-width: 50px;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .timeline-status {
            font-size: 12px;
            color: #666;
        }

        .timeline-duration {
            font-size: 12px;
            color: #8e8e93;
            font-weight: 500;
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 12px;
            z-index: 300;
            background: rgba(255,255,255,0.98);
            padding: 8px;
            border-radius: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .bottom-toolbar.visible {
            display: flex;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #f2f2f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-btn:active {
            transform: scale(0.9);
        }

        .tool-btn.primary {
            background: var(--primary);
            color: white;
        }

        .tool-btn.danger {
            background: var(--danger);
            color: white;
        }

        /* Modals */
        .sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 400;
        }

        .sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 500;
            max-height: 70vh;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 5px;
            background: #c7c7cc;
            border-radius: 3px;
            margin: 0 auto 20px;
        }

        .sheet-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .status-opt {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .status-opt:active {
            transform: scale(0.95);
        }

        .status-opt.selected {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .status-opt .icon {
            font-size: 28px;
        }

        .sheet-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
        }

        .sheet-input:focus {
            border-color: var(--primary);
        }

        .sheet-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
        }

        .sheet-btn:active {
            transform: scale(0.98);
        }

        /* Full Modals */
        .modal-full {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            z-index: 600;
            transform: translateY(100%);
            transition: transform 0.3s;
            overflow-y: auto;
        }

        .modal-full.active {
            transform: translateY(0);
        }

        .modal-header {
            background: white;
            padding: 50px 16px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f2f2f7;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .form-section {
            padding: 20px;
            background: white;
            margin-bottom: 12px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 700;
            color: #8e8e93;
            text-transform: uppercase;
            margin-bottom: 10px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary);
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
        }

        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .role-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn.selected {
            border-color: var(--primary);
            background: #f0f4ff;
            color: var(--primary);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .hidden { display: none !important; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8e8e93;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 15px;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Login -->
    <div class="login-screen" id="loginScreen">
        <div class="water-bg"></div>
        <div class="login-logo">üõ°Ô∏è</div>
        <div class="login-title">–ö–æ–Ω—Ç—Ä–æ–ª—å –ü—Ä–æ—Ö–æ–¥—É</div>
        
        <div class="pin-container">
            <div class="water-fill" id="waterFill"></div>
            <div class="pin-display" id="pinDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            
            <div class="pin-keypad">
                <button class="pin-btn" onclick="addPin(1)">1</button>
                <button class="pin-btn" onclick="addPin(2)">2</button>
                <button class="pin-btn" onclick="addPin(3)">3</button>
                <button class="pin-btn" onclick="addPin(4)">4</button>
                <button class="pin-btn" onclick="addPin(5)">5</button>
                <button class="pin-btn" onclick="addPin(6)">6</button>
                <button class="pin-btn" onclick="addPin(7)">7</button>
                <button class="pin-btn" onclick="addPin(8)">8</button>
                <button class="pin-btn" onclick="addPin(9)">9</button>
                <button class="pin-btn clear" onclick="clearPin()">‚å´</button>
                <button class="pin-btn" onclick="addPin(0)">0</button>
                <button class="pin-btn enter" onclick="checkPin()">‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1>üè¢ –ü—Ä–æ—Ö—ñ–¥–Ω–∞</h1>
                <div class="datetime" id="currentTime">--:--</div>
            </div>
            <div class="user-badge">
                <span id="headerName">--</span>
                <span class="role-badge" id="headerRole">--</span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav" id="tabNav">
            <button class="tab-btn active" onclick="switchTab('personnel')">
                <span>üë•</span> –ü–µ—Ä—Å–æ–Ω–∞–ª
            </button>
            <button class="tab-btn" onclick="switchTab('stats')">
                <span>üìä</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
            <button class="tab-btn" onclick="switchTab('admin')">
                <span>‚öôÔ∏è</span> –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions" id="quickActions">
            <div class="action-btn" id="btn-in" onclick="applyQuickStatus('in', 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ')">
                <span class="action-icon">üè¢</span>
                <span class="action-label">–í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</span>
            </div>
            <div class="action-btn" id="btn-vz" onclick="applyQuickStatus('vz', 'üìû –í–ó')">
                <span class="action-icon">üìû</span>
                <span class="action-label">–í–ó</span>
            </div>
            <div class="action-btn" id="btn-rz" onclick="applyQuickStatus('rz', 'üìã –†–ó')">
                <span class="action-icon">üìã</span>
                <span class="action-label">–†–ó</span>
            </div>
            <div class="action-btn" id="btn-lunch" onclick="applyQuickStatus('lunch', 'üçΩÔ∏è –û–±—ñ–¥')">
                <span class="action-icon">üçΩÔ∏è</span>
                <span class="action-label">–û–±—ñ–¥</span>
            </div>
            <div class="action-btn" id="btn-custom" onclick="openCustomStatus()">
                <span class="action-icon">‚ö°</span>
                <span class="action-label">–Ü–Ω—à–µ</span>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-pill">
                <div class="stat-dot" style="background: #333;"></div>
                <span class="stat-label">–í—Å—å–æ–≥–æ</span>
                <span class="stat-num" id="statTotal">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--success);"></div>
                <span class="stat-label">–í –±—É–¥—ñ–≤–ª—ñ</span>
                <span class="stat-num" id="statIn">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--info);"></div>
                <span class="stat-label">–ù–∞ –í–ó</span>
                <span class="stat-num" id="statVz">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--danger);"></div>
                <span class="stat-label">–í—ñ–¥—Å—É—Ç–Ω—ñ</span>
                <span class="stat-num" id="statOut">0</span>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Personnel Tab -->
            <div class="tab-content active" id="tab-personnel">
                <div class="section-title">
                    <span>–ü–ï–†–°–û–ù–ê–õ</span>
                    <span class="selection-hint" id="selectionHint">–¢–∞–ø–∞–π—Ç–µ –¥–ª—è –≤–∏–±–æ—Ä—É</span>
                </div>
                <div class="person-grid" id="personGrid"></div>
            </div>

            <!-- Statistics Tab -->
            <div class="tab-content" id="tab-stats">
                <div class="stats-container">
                    <div class="chart-card">
                        <div class="chart-title">üìà –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑–∞ –¥–µ–Ω—å</div>
                        <div class="chart-bars" id="chartBars"></div>
                    </div>
                    
                    <div class="timeline-card">
                        <div class="chart-title">üïê –Ü—Å—Ç–æ—Ä—ñ—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω—å</div>
                        <div id="timelineList"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div class="tab-content" id="tab-admin">
                <div class="form-section">
                    <label class="form-label">‚ûï –ù–æ–≤–∏–π —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</label>
                    <input type="text" class="form-input" id="newPersonName" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ">
                    <input type="text" class="form-input" id="newPersonPin" placeholder="PIN (4 —Ü–∏—Ñ—Ä–∏)" maxlength="4">
                    
                    <label class="form-label">–ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å</label>
                    <div class="status-grid" style="margin-bottom: 16px;">
                        <div class="status-opt" onclick="selectNewStatus('in', 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ')" style="background: #e8f5e9;">
                            <span class="icon">üè¢</span>
                            <span>–í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</span>
                        </div>
                        <div class="status-opt" onclick="selectNewStatus('vz', 'üìû –í–ó')" style="background: #e3f2fd;">
                            <span class="icon">üìû</span>
                            <span>–í–ó</span>
                        </div>
                        <div class="status-opt" onclick="selectNewStatus('rz', 'üìã –†–ó')" style="background: #fff3e0;">
                            <span class="icon">üìã</span>
                            <span>–†–ó</span>
                        </div>
                        <div class="status-opt" onclick="selectNewStatus('out', '‚ö™ –ù–µ –Ω–∞ —Ä–æ–±–æ—Ç—ñ')" style="background: #f5f5f5;">
                            <span class="icon">‚ö™</span>
                            <span>–ù–µ –Ω–∞ —Ä–æ–±–æ—Ç—ñ</span>
                        </div>
                    </div>
                    
                    <button class="save-btn" onclick="addNewPerson()">‚úÖ –î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</button>
                </div>

                <div class="form-section">
                    <label class="form-label">üë§ –ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∏—Å—Ç–µ–º–∏</label>
                    <input type="text" class="form-input" id="adminName" placeholder="–ü–Ü–ë">
                    <input type="text" class="form-input" id="adminPin" placeholder="PIN" maxlength="4">
                    
                    <label class="form-label">–†–æ–ª—å</label>
                    <div class="role-selector">
                        <button class="role-btn selected" onclick="setRole('editor')" data-role="editor">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</button>
                        <button class="role-btn" onclick="setRole('reader')" data-role="reader">üëÅÔ∏è –ß–∏—Ç–∞—á</button>
                    </div>
                    
                    <button class="save-btn" onclick="addAdminUser()" style="background: var(--info);">‚ûï –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
                </div>

                <div class="form-section">
                    <label class="form-label">üìã –°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</label>
                    <div id="adminList"></div>
                </div>

                <div style="padding: 20px;">
                    <button class="save-btn" onclick="exportData()" style="background: #333; margin-bottom: 12px;">üìä –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
                    <button class="save-btn" onclick="logout()" style="background: var(--danger);">üö™ –í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Toolbar -->
<div class="bottom-toolbar" id="toolbar">
    <button class="tool-btn danger" onclick="clearSelection()" title="–°–∫–∞—Å—É–≤–∞—Ç–∏">‚úï</button>
    <button class="tool-btn primary" onclick="openBulkSheet()" title="–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å">üìù</button>
    <span style="display: flex; align-items: center; padding: 0 8px; font-size: 14px; font-weight: 600; color: #333;" id="selectedCount">0</span>
</div>

<!-- Status Sheet -->
<div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="statusSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheetTitle">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</div>
    
    <div class="status-grid">
        <div class="status-opt" onclick="selectStatus('in', 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ')" style="background: #e8f5e9;">
            <span class="icon">üè¢</span>
            <span>–í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</span>
        </div>
        <div class="status-opt" onclick="selectStatus('vz', 'üìû –í–ó')" style="background: #e3f2fd;">
            <span class="icon">üìû</span>
            <span>–í–ó</span>
        </div>
        <div class="status-opt" onclick="selectStatus('rz', 'üìã –†–ó')" style="background: #fff3e0;">
            <span class="icon">üìã</span>
            <span>–†–ó</span>
        </div>
        <div class="status-opt" onclick="selectStatus('lunch', 'üçΩÔ∏è –û–±—ñ–¥')" style="background: #fce4ec;">
            <span class="icon">üçΩÔ∏è</span>
            <span>–û–±—ñ–¥</span>
        </div>
        <div class="status-opt" onclick="selectStatus('meeting', 'üë• –ù–∞—Ä–∞–¥–∞')" style="background: #f3e5f5;">
            <span class="icon">üë•</span>
            <span>–ù–∞—Ä–∞–¥–∞</span>
        </div>
        <div class="status-opt" onclick="selectStatus('home', 'üè† –î–æ–¥–æ–º—É')" style="background: #ffebee;">
            <span class="icon">üè†</span>
            <span>–î–æ–¥–æ–º—É</span>
        </div>
        <div class="status-opt" onclick="selectStatus('hospital', 'üè• –õ—ñ–∫–∞—Ä–Ω—è')" style="background: #e0f2f1;">
            <span class="icon">üè•</span>
            <span>–õ—ñ–∫–∞—Ä–Ω—è</span>
        </div>
        <div class="status-opt" onclick="selectStatus('trip', '‚úàÔ∏è –í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è')" style="background: #fff8e1;">
            <span class="icon">‚úàÔ∏è</span>
            <span>–í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</span>
        </div>
    </div>

    <input type="text" class="sheet-input" id="sheetCustom" placeholder="–°–≤—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç —Å—Ç–∞—Ç—É—Å—É...">
    <button class="sheet-btn" onclick="applyStatus()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–º—ñ–Ω–∏</button>
</div>

<!-- Custom Status Sheet -->
<div class="bottom-sheet" id="customStatusSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">‚ö° –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ç—É—Å</div>
    <input type="text" class="sheet-input" id="quickCustomInput" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å–≤—ñ–π —Å—Ç–∞—Ç—É—Å...">
    <button class="sheet-btn" onclick="applyQuickCustom()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–±—Ä–∞–Ω–∏—Ö</button>
</div>

<div class="toast" id="toast"></div>

<script>
// Data
let currentUser = null;
let currentPin = '';
let selectedRole = 'editor';
let selectedPersons = new Set();
let sheetTargets = [];
let sheetStatus = null;
let sheetText = '';
let newPersonStatus = 'in';
let newPersonStatusText = 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ';
let currentTab = 'personnel';

// 11 Employees
let users = [
    { pin: '1111', name: '–®–µ–≤—á–µ–Ω–∫–æ –û.–ü.', role: 'admin' },
    { pin: '2222', name: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –ú.–Ü.', role: 'editor' },
    { pin: '3333', name: '–ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ –°.–ú.', role: 'reader' },
    { pin: '4444', name: '–¢–∫–∞—á–µ–Ω–∫–æ –ê.–í.', role: 'editor' },
    { pin: '5555', name: '–ú–µ–ª—å–Ω–∏–∫ –í.–û.', role: 'reader' }
];

let personnel = [
    { id: 1, name: '–®–µ–≤—á–µ–Ω–∫–æ –û.–ü.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', currentSessionStart: new Date(Date.now()-7200000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-7200000).toISOString(),end:null}] },
    { id: 2, name: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –ú.–Ü.', status: 'vz', statusText: 'üìû –í–ó', currentSessionStart: new Date(Date.now()-1800000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-10800000).toISOString(),end:new Date(Date.now()-1800000).toISOString()},{status:'vz',text:'üìû –í–ó',start:new Date(Date.now()-1800000).toISOString(),end:null}] },
    { id: 3, name: '–ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ –°.–ú.', status: 'rz', statusText: 'üìã –†–ó', currentSessionStart: new Date(Date.now()-3600000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-14400000).toISOString(),end:new Date(Date.now()-3600000).toISOString()},{status:'rz',text:'üìã –†–ó',start:new Date(Date.now()-3600000).toISOString(),end:null}] },
    { id: 4, name: '–¢–∫–∞—á–µ–Ω–∫–æ –ê.–í.', status: 'lunch', statusText: 'üçΩÔ∏è –û–±—ñ–¥', currentSessionStart: new Date(Date.now()-2700000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-18000000).toISOString(),end:new Date(Date.now()-2700000).toISOString()},{status:'lunch',text:'üçΩÔ∏è –û–±—ñ–¥',start:new Date(Date.now()-2700000).toISOString(),end:null}] },
    { id: 5, name: '–ú–µ–ª—å–Ω–∏–∫ –í.–û.', status: 'meeting', statusText: 'üë• –ù–∞—Ä–∞–¥–∞', currentSessionStart: new Date(Date.now()-5400000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-9000000).toISOString(),end:new Date(Date.now()-5400000).toISOString()},{status:'meeting',text:'üë• –ù–∞—Ä–∞–¥–∞',start:new Date(Date.now()-5400000).toISOString(),end:null}] },
    { id: 6, name: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –Ü.–î.', status: 'home', statusText: 'üè† –î–æ–¥–æ–º—É', currentSessionStart: new Date(Date.now()-86400000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-172800000).toISOString(),end:new Date(Date.now()-86400000).toISOString()},{status:'home',text:'üè† –î–æ–¥–æ–º—É',start:new Date(Date.now()-86400000).toISOString(),end:null}] },
    { id: 7, name: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –ù.–ü.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', currentSessionStart: new Date(Date.now()-14400000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-14400000).toISOString(),end:null}] },
    { id: 8, name: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –û.–í.', status: 'vz', statusText: 'üìû –í–ó', currentSessionStart: new Date(Date.now()-4500000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-21600000).toISOString(),end:new Date(Date.now()-7200000).toISOString()},{status:'rz',text:'üìã –†–ó',start:new Date(Date.now()-7200000).toISOString(),end:new Date(Date.now()-4500000).toISOString()},{status:'vz',text:'üìû –í–ó',start:new Date(Date.now()-4500000).toISOString(),end:null}] },
    { id: 9, name: '–õ–∏—Å–µ–Ω–∫–æ –û.–ú.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', currentSessionStart: new Date(Date.now()-10800000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-10800000).toISOString(),end:null}] },
    { id: 10, name: '–ú–æ—Ä–æ–∑–æ–≤ –î.–°.', status: 'rz', statusText: 'üìã –†–ó', currentSessionStart: new Date(Date.now()-5400000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-12600000).toISOString(),end:new Date(Date.now()-5400000).toISOString()},{status:'rz',text:'üìã –†–ó',start:new Date(Date.now()-5400000).toISOString(),end:null}] },
    { id: 11, name: '–í–∞—Å–∏–ª—å—î–≤–∞ –Ü.–ü.', status: 'lunch', statusText: 'üçΩÔ∏è –û–±—ñ–¥', currentSessionStart: new Date(Date.now()-1800000).toISOString(), history: [{status:'in',text:'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ',start:new Date(Date.now()-9000000).toISOString(),end:new Date(Date.now()-1800000).toISOString()},{status:'lunch',text:'üçΩÔ∏è –û–±—ñ–¥',start:new Date(Date.now()-1800000).toISOString(),end:null}] }
];

// Clock
function updateTime() {
    const now = new Date();
    const el = document.getElementById('currentTime');
    if (el) el.textContent = now.toLocaleTimeString('uk-UA', {hour:'2-digit',minute:'2-digit'});
}
setInterval(updateTime, 1000);
updateTime();

// PIN Functions
function addPin(num) {
    if (currentPin.length < 4) {
        currentPin += num;
        updatePin();
        const fill = document.getElementById('waterFill');
        if (fill) fill.style.height = (currentPin.length / 4 * 100) + '%';
    }
}

function clearPin() {
    currentPin = currentPin.slice(0, -1);
    updatePin();
    const fill = document.getElementById('waterFill');
    if (fill) fill.style.height = (currentPin.length / 4 * 100) + '%';
    const disp = document.getElementById('pinDisplay');
    if (disp) disp.classList.remove('error');
}

function updatePin() {
    const disp = document.getElementById('pinDisplay');
    if (disp) disp.textContent = currentPin.length === 0 ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '‚Ä¢'.repeat(currentPin.length) + '‚Ä¢'.repeat(4 - currentPin.length);
}

function checkPin() {
    if (currentPin.length !== 4) return;
    
    const user = users.find(u => u.pin === currentPin);
    if (user) {
        const disp = document.getElementById('pinDisplay');
        const fill = document.getElementById('waterFill');
        if (disp) disp.classList.add('success');
        if (fill) fill.style.height = '100%';
        
        setTimeout(() => {
            currentUser = user;
            
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const headerName = document.getElementById('headerName');
            const headerRole = document.getElementById('headerRole');
            const quickActions = document.getElementById('quickActions');
            const toolbar = document.getElementById('toolbar');
            
            if (loginScreen) loginScreen.style.display = 'none';
            if (mainApp) {
                mainApp.style.display = 'flex';
                mainApp.classList.add('active');
            }
            
            if (headerName) headerName.textContent = user.name.split(' ')[0];
            if (headerRole) headerRole.textContent = user.role;
            
            // Role-based visibility
            if (user.role === 'reader') {
                if (quickActions) quickActions.style.display = 'none';
                if (toolbar) toolbar.style.display = 'none';
                // Switch to stats tab for readers
                switchTab('stats');
            } else {
                if (quickActions) quickActions.style.display = 'grid';
                if (toolbar) toolbar.style.display = 'flex';
            }
            
            renderGrid();
            updateStats();
            renderStats();
            renderAdminList();
            
            currentPin = '';
            updatePin();
            if (fill) {
                fill.style.height = '0%';
                fill.style.background = '';
            }
            if (disp) disp.classList.remove('success');
            showToast('–í—ñ—Ç–∞—î–º–æ, ' + user.name.split(' ')[0] + '!');
        }, 400);
    } else {
        const disp = document.getElementById('pinDisplay');
        const fill = document.getElementById('waterFill');
        if (disp) disp.classList.add('error');
        if (fill) fill.style.background = 'rgba(255, 59, 48, 0.4)';
        
        setTimeout(() => {
            currentPin = '';
            updatePin();
            if (disp) disp.classList.remove('error');
            if (fill) {
                fill.style.height = '0%';
                fill.style.background = '';
            }
        }, 600);
    }
}

// Tab Switching
function switchTab(tab) {
    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById('tab-' + tab).classList.add('active');
    
    if (tab === 'stats') renderStats();
    if (tab === 'admin') renderAdminList();
}

// Quick Actions - Apply to ALL selected (not just first)
function applyQuickStatus(status, text) {
    if (!currentUser || currentUser.role === 'reader') {
        showToast('‚õî –ù–µ–º–∞—î –ø—Ä–∞–≤');
        return;
    }
    
    const targets = selectedPersons.size > 0 ? Array.from(selectedPersons) : 
                   personnel.filter(p => p.name === currentUser.name).map(p => p.id);
    
    if (targets.length === 0) {
        showToast('‚õî –ù–µ–º–∞—î —Ü—ñ–ª–µ–π');
        return;
    }
    
    targets.forEach(id => {
        const person = personnel.find(p => p.id === id);
        if (person) changeStatus(person, status, text);
    });
    
    // Update UI
    updateQuickButtons(status);
    showToast('‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ ' + targets.length + ' —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤');
    
    // Clear selection after action
    if (selectedPersons.size > 0) {
        clearSelection();
    }
}

function updateQuickButtons(activeStatus) {
    ['in', 'vz', 'rz', 'lunch'].forEach(s => {
        const btn = document.getElementById('btn-' + s);
        if (btn) btn.classList.toggle('active', s === activeStatus);
    });
}

function openCustomStatus() {
    if (!currentUser || currentUser.role === 'reader') {
        showToast('‚õî –ù–µ–º–∞—î –ø—Ä–∞–≤');
        return;
    }
    
    const overlay = document.getElementById('sheetOverlay');
    const sheet = document.getElementById('customStatusSheet');
    const input = document.getElementById('quickCustomInput');
    
    if (overlay) overlay.classList.add('active');
    if (sheet) sheet.classList.add('active');
    if (input) {
        input.value = '';
        setTimeout(() => input.focus(), 100);
    }
}

function applyQuickCustom() {
    const input = document.getElementById('quickCustomInput');
    const text = input ? input.value.trim() : '';
    
    if (!text) {
        showToast('‚õî –í–≤–µ–¥—ñ—Ç—å —Å—Ç–∞—Ç—É—Å');
        return;
    }
    
    applyQuickStatus('custom', '‚ö° ' + text);
    closeSheet();
}

// Status Management
function changeStatus(person, status, text) {
    const now = new Date().toISOString();
    if (person.history && person.history.length && !person.history[person.history.length-1].end) {
        person.history[person.history.length-1].end = now;
    }
    person.status = status;
    person.statusText = text;
    person.currentSessionStart = now;
    if (!person.history) person.history = [];
    person.history.push({status, text, start: now, end: null});
    if (person.history.length > 5) person.history = person.history.slice(-5);
    
    renderGrid();
    updateStats();
}

function getColor(s) {
    const c = {in:'#34c759', vz:'#007aff', rz:'#ff9500', lunch:'#ff9500', meeting:'#af52de', home:'#ff3b30', out:'#999', custom:'#667eea'};
    return c[s] || '#999';
}

function calcDur(a, b) {
    const d = new Date(b) - new Date(a);
    const h = Math.floor(d/3600000), m = Math.floor((d%3600000)/60000);
    if (h > 0) return h + '–≥ ' + m + '—Ö–≤';
    return m + '—Ö–≤';
}

// Grid Rendering - Tap to select (no checkboxes)
function renderGrid() {
    const grid = document.getElementById('personGrid');
    const sectionTitle = document.querySelector('.section-title span:first-child');
    const hint = document.getElementById('selectionHint');
    
    if (!grid) return;
    grid.innerHTML = '';
    
    if (sectionTitle) sectionTitle.textContent = '–ü–ï–†–°–û–ù–ê–õ (' + personnel.length + ')';
    if (hint) hint.classList.toggle('visible', selectedPersons.size > 0);
    
    const isReader = !currentUser || currentUser.role === 'reader';
    
    personnel.forEach(p => {
        const isSel = selectedPersons.has(p.id);
        const last = p.history && p.history.length ? p.history[p.history.length-1] : null;
        const dur = last ? calcDur(last.start, last.end || new Date().toISOString()) : '--';
        
        const card = document.createElement('div');
        card.className = 'person-card ' + (isSel ? 'selected' : '');
        
        // Single tap for readers, tap to select for editors
        card.onclick = function(e) {
            if (isReader) return;
            
            if (selectedPersons.size === 0 && !isSel) {
                // First selection - just select
                toggleSelect(p.id);
            } else {
                // Multi-select mode
                toggleSelect(p.id);
            }
        };
        
        // Long press or double tap for quick status change when not in selection mode
        card.ondblclick = function(e) {
            if (isReader) return;
            if (selectedPersons.size === 0) {
                openSheet([p.id]);
            }
        };
        
        card.innerHTML = 
            '<div class="person-header">' +
                '<div class="person-avatar">' + p.name.charAt(0) + '</div>' +
                '<div class="person-info">' +
                    '<div class="person-name">' + p.name + '</div>' +
                    '<div class="person-time">' + dur + ' ‚Ä¢ ' + p.statusText.split(' ')[0] + '</div>' +
                '</div>' +
            '</div>' +
            '<span class="status-badge" style="background:' + getColor(p.status) + ';">' + p.statusText + '</span>';
        
        grid.appendChild(card);
    });
}

function toggleSelect(id) {
    if (selectedPersons.has(id)) {
        selectedPersons.delete(id);
    } else {
        selectedPersons.add(id);
    }
    updateSelUI();
    renderGrid();
}

function updateSelUI() {
    const n = selectedPersons.size;
    const toolbar = document.getElementById('toolbar');
    const count = document.getElementById('selectedCount');
    
    if (toolbar) toolbar.classList.toggle('visible', n > 0);
    if (count) count.textContent = n;
}

function clearSelection() {
    selectedPersons.clear();
    updateSelUI();
    renderGrid();
}

function updateStats() {
    const total = document.getElementById('statTotal');
    const statIn = document.getElementById('statIn');
    const statVz = document.getElementById('statVz');
    const statOut = document.getElementById('statOut');
    
    if (total) total.textContent = personnel.length;
    if (statIn) statIn.textContent = personnel.filter(p => p.status === 'in').length;
    if (statVz) statVz.textContent = personnel.filter(p => p.status === 'vz').length;
    if (statOut) statOut.textContent = personnel.filter(p => ['home','out','hospital','trip'].includes(p.status)).length;
}

// Statistics Tab
function renderStats() {
    renderChart();
    renderTimeline();
}

function renderChart() {
    const container = document.getElementById('chartBars');
    if (!container) return;
    
    const stats = {
        '00-04': 0, '04-08': 0, '08-12': 0, '12-16': 0, '16-20': 0, '20-24': 0
    };
    
    const today = new Date().toDateString();
    
    personnel.forEach(p => {
        if (!p.history) return;
        p.history.forEach(h => {
            const start = new Date(h.start);
            if (start.toDateString() !== today) return;
            
            const hour = start.getHours();
            let slot;
            if (hour < 4) slot = '00-04';
            else if (hour < 8) slot = '04-08';
            else if (hour < 12) slot = '08-12';
            else if (hour < 16) slot = '12-16';
            else if (hour < 20) slot = '16-20';
            else slot = '20-24';
            
            stats[slot]++;
        });
    });
    
    const max = Math.max(...Object.values(stats), 1);
    
    container.innerHTML = Object.entries(stats).map(([label, val]) => {
        const height = (val / max * 100);
        const colors = ['#667eea', '#764ba2', '#34c759', '#ff9500', '#007aff', '#af52de'];
        const color = colors[Object.keys(stats).indexOf(label) % colors.length];
        
        return `
            <div class="chart-bar-group">
                <div class="chart-bar" style="height: ${height}%; background: ${color};">
                    ${val > 0 ? `<span class="chart-value">${val}</span>` : ''}
                </div>
                <span class="chart-bar-label">${label}</span>
            </div>
        `;
    }).join('');
}

function renderTimeline() {
    const container = document.getElementById('timelineList');
    if (!container) return;
    
    const today = new Date().toDateString();
    const events = [];
    
    personnel.forEach(p => {
        if (!p.history) return;
        p.history.forEach(h => {
            const start = new Date(h.start);
            if (start.toDateString() !== today) return;
            
            events.push({
                time: start,
                name: p.name,
                status: h.text,
                duration: h.end ? calcDur(h.start, h.end) : '—Ç—Ä–∏–≤–∞—î...'
            });
        });
    });
    
    events.sort((a, b) => b.time - a.time);
    
    if (events.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <div class="empty-text">–°—å–æ–≥–æ–¥–Ω—ñ —â–µ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = events.slice(0, 20).map(e => `
        <div class="timeline-item">
            <div class="timeline-time">${e.time.getHours().toString().padStart(2,'0')}:${e.time.getMinutes().toString().padStart(2,'0')}</div>
            <div class="timeline-content">
                <div class="timeline-name">${e.name}</div>
                <div class="timeline-status">${e.status} ‚Ä¢ ${e.duration}</div>
            </div>
        </div>
    `).join('');
}

// Sheets
function openSheet(ids) {
    sheetTargets = ids;
    const title = document.getElementById('sheetTitle');
    const overlay = document.getElementById('sheetOverlay');
    const sheet = document.getElementById('statusSheet');
    
    if (title) title.textContent = ids.length === 1 ? '–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å' : '–ó–º—ñ–Ω–∏—Ç–∏ (' + ids.length + ') —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤';
    if (overlay) overlay.classList.add('active');
    if (sheet) sheet.classList.add('active');
    
    document.querySelectorAll('#statusSheet .status-opt').forEach(el => el.classList.remove('selected'));
    const custom = document.getElementById('sheetCustom');
    if (custom) custom.value = '';
    sheetStatus = null;
}

function openBulkSheet() {
    openSheet(Array.from(selectedPersons));
}

function closeSheet() {
    const overlay = document.getElementById('sheetOverlay');
    const statusSheet = document.getElementById('statusSheet');
    const customSheet = document.getElementById('customStatusSheet');
    
    if (overlay) overlay.classList.remove('active');
    if (statusSheet) statusSheet.classList.remove('active');
    if (customSheet) customSheet.classList.remove('active');
}

function selectStatus(st, txt) {
    document.querySelectorAll('#statusSheet .status-opt').forEach(el => el.classList.remove('selected'));
    if (event && event.currentTarget) event.currentTarget.classList.add('selected');
    sheetStatus = st;
    sheetText = txt;
    const custom = document.getElementById('sheetCustom');
    if (custom) custom.value = '';
}

function applyStatus() {
    const customEl = document.getElementById('sheetCustom');
    const cst = customEl ? customEl.value.trim() : '';
    const st = cst ? 'custom' : sheetStatus;
    const txt = cst ? '‚ö° ' + cst : sheetText;
    
    if (!st) {
        showToast('‚õî –û–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—É—Å');
        return;
    }
    
    sheetTargets.forEach(id => {
        const p = personnel.find(x => x.id === id);
        if (p) changeStatus(p, st, txt);
    });
    
    showToast('‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ ' + sheetTargets.length + ' —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤!');
    closeSheet();
    clearSelection();
}

// Admin Functions
function selectNewStatus(st, txt) {
    document.querySelectorAll('#addPersonModal .status-opt').forEach(el => el.classList.remove('selected'));
    if (event && event.currentTarget) event.currentTarget.classList.add('selected');
    newPersonStatus = st;
    newPersonStatusText = txt;
}

function addNewPerson() {
    const nameEl = document.getElementById('newPersonName');
    const pinEl = document.getElementById('newPersonPin');
    const name = nameEl ? nameEl.value.trim() : '';
    const pin = pinEl ? pinEl.value.trim() : '';
    
    if (!name || pin.length !== 4) {
        showToast('‚õî –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
        return;
    }
    
    if (users.find(u => u.pin === pin)) {
        showToast('‚õî PIN –∑–∞–π–Ω—è—Ç–∏–π');
        return;
    }
    
    const now = new Date().toISOString();
    
    personnel.push({
        id: Date.now(),
        name: name,
        status: newPersonStatus,
        statusText: newPersonStatusText,
        currentSessionStart: now,
        history: [{status: newPersonStatus, text: newPersonStatusText, start: now, end: null}]
    });
    
    users.push({pin: pin, name: name, role: 'reader'});
    
    if (nameEl) nameEl.value = '';
    if (pinEl) pinEl.value = '';
    
    renderGrid();
    updateStats();
    renderStats();
    showToast('‚úÖ –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ –¥–æ–¥–∞–Ω–æ!');
}

function setRole(r) {
    selectedRole = r;
    document.querySelectorAll('.role-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    const btn = document.querySelector('[data-role="' + r + '"]');
    if (btn) btn.classList.add('selected');
}

function addAdminUser() {
    const nameEl = document.getElementById('adminName');
    const pinEl = document.getElementById('adminPin');
    const n = nameEl ? nameEl.value.trim() : '';
    const p = pinEl ? pinEl.value.trim() : '';
    
    if (!n || p.length !== 4) {
        showToast('‚õî –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
        return;
    }
    if (users.find(u => u.pin === p)) {
        showToast('‚õî PIN –∑–∞–π–Ω—è—Ç–∏–π');
        return;
    }
    
    users.push({pin:p, name:n, role:selectedRole});
    
    if (nameEl) nameEl.value = '';
    if (pinEl) pinEl.value = '';
    
    renderAdminList();
    showToast('‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ!');
}

function renderAdminList() {
    const c = document.getElementById('adminList');
    if (!c) return;
    
    c.innerHTML = '';
    
    users.forEach(u => {
        const d = document.createElement('div');
        d.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0;';
        
        const color = u.role === 'admin' ? '#e74c3c' : u.role === 'editor' ? '#007aff' : '#666';
        const bg = u.role === 'admin' ? '#ffebee' : u.role === 'editor' ? '#e3f2fd' : '#f2f2f7';
        
        d.innerHTML = 
            '<div>' +
                '<div style="font-weight:600;font-size:15px;color:#333;">' + u.name + '</div>' +
                '<div style="font-size:12px;color:#8e8e93;">PIN: ' + u.pin + '</div>' +
            '</div>' +
            '<span style="font-size:11px;padding:6px 12px;border-radius:12px;background:' + bg + ';color:' + color + ';font-weight:600;text-transform:uppercase;">' + u.role + '</span>';
        
        c.appendChild(d);
    });
}

function exportData() {
    let csv = '–ü–Ü–ë,–°—Ç–∞—Ç—É—Å,–ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∑–º—ñ–Ω–∏\n';
    personnel.forEach(p => {
        const lastTime = p.currentSessionStart ? new Date(p.currentSessionStart).toLocaleString('uk-UA') : '-';
        csv += '"' + p.name + '","' + p.statusText + '","' + lastTime + '"\n';
    });
    const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '–ø—Ä–æ—Ö–æ–¥_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    showToast('üìä –ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
}

function logout() {
    currentUser = null;
    selectedPersons.clear();
    
    const loginScreen = document.getElementById('loginScreen');
    const mainApp = document.getElementById('mainApp');
    const toolbar = document.getElementById('toolbar');
    
    if (loginScreen) loginScreen.style.display = 'flex';
    if (mainApp) {
        mainApp.style.display = 'none';
        mainApp.classList.remove('active');
    }
    if (toolbar) toolbar.classList.remove('visible');
    
    // Reset tabs
    document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === 0);
    });
    document.querySelectorAll('.tab-content').forEach((content, i) => {
        content.classList.toggle('active', i === 0);
    });
    
    currentPin = '';
    updatePin();
    const fill = document.getElementById('waterFill');
    if (fill) fill.style.height = '0%';
}

function showToast(m) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.textContent = m;
    t.classList.add('show');
    setTimeout(function() {
        t.classList.remove('show');
    }, 2500);
}

// Touch handling
let touchStartY = 0;
document.addEventListener('touchstart', function(e) {
    touchStartY = e.touches[0].clientY;
});
document.addEventListener('touchmove', function(e) {
    const diff = e.touches[0].clientY - touchStartY;
    if (diff > 100) {
        const sheet = document.querySelector('.bottom-sheet.active');
        if (sheet) closeSheet();
    }
});

// Init
renderGrid();
updateStats();
</script>

</body>
</html>
