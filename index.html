<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üö™ –ö–æ–Ω—Ç—Ä–æ–ª—å –ü—Ä–æ—Ö–æ–¥—É</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --info: #007aff;
            --bg: #f2f2f7;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #333;
            height: 100%;
            width: 100%;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 430px;
            margin: 0 auto;
            background: var(--bg);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        .login-screen {
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .water-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25%;
            background: rgba(255,255,255,0.08);
            border-radius: 50% 50% 0 0;
            animation: wave 6s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-logo {
            font-size: 56px;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .login-title {
            color: white;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 30px;
            z-index: 10;
            text-align: center;
        }

        .pin-container {
            background: rgba(255,255,255,0.98);
            border-radius: 24px;
            padding: 28px;
            width: 300px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.5) 100%);
            transition: height 0.3s ease;
            height: 0%;
            z-index: 0;
        }

        .pin-display {
            background: #f2f2f7;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 3px solid transparent;
            position: relative;
            z-index: 1;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #d1d1d6;
            transition: all 0.2s ease;
        }

        .pin-dot.filled {
            background: var(--primary);
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .pin-display.error {
            border-color: var(--danger);
            animation: shake 0.4s;
        }

        .pin-display.error .pin-dot.filled {
            background: var(--danger);
        }

        .pin-display.success .pin-dot.filled {
            background: var(--success);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .pin-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 50%;
            background: #e5e5ea;
            color: #333;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .pin-btn:active {
            transform: scale(0.92);
            background: #d1d1d6;
        }

        .pin-btn.clear {
            background: var(--danger);
            color: white;
            font-size: 20px;
        }

        .pin-btn.enter {
            background: var(--success);
            color: white;
            font-size: 24px;
        }

        /* Main App */
        .main-app {
            flex: 1;
            display: none;
            flex-direction: column;
            background: var(--bg);
            height: 100%;
            overflow: hidden;
        }

        .main-app.active {
            display: flex;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            color: white;
            padding: 50px 16px 12px;
            flex-shrink: 0;
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .datetime {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .role-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.25);
            text-transform: uppercase;
            font-weight: 700;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: white;
            margin: 8px 12px 0;
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            padding: 8px 12px;
            background: white;
            margin: 8px 12px;
            border-radius: 16px;
            flex-shrink: 0;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 2px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.active {
            background: #f0f4ff;
            border-color: var(--primary);
        }

        .action-icon {
            font-size: 24px;
            line-height: 1;
        }

        .action-label {
            font-size: 10px;
            font-weight: 600;
            color: #333;
            text-align: center;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 8px;
            padding: 0 12px 8px;
            flex-shrink: 0;
        }

        .stat-pill {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .stat-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stat-label {
            font-size: 9px;
            color: #666;
            font-weight: 500;
        }

        .stat-num {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 0 12px 80px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
        }

        .tab-content.active {
            opacity: 1;
            visibility: visible;
        }

        /* Personnel Section */
        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: #8e8e93;
            text-transform: uppercase;
            padding: 12px 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-hint {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .selection-hint.visible {
            opacity: 1;
        }

        .person-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .person-card {
            background: white;
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .person-card:active {
            transform: scale(0.98);
        }

        .person-card.selected {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .person-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .person-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .person-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .person-info {
            flex: 1;
            min-width: 0;
        }

        .person-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-time {
            font-size: 11px;
            color: #8e8e93;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            align-self: flex-start;
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 12px;
            z-index: 300;
            background: rgba(255,255,255,0.98);
            padding: 8px;
            border-radius: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .bottom-toolbar.visible {
            display: flex;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #f2f2f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-btn:active {
            transform: scale(0.9);
        }

        .tool-btn.primary {
            background: var(--primary);
            color: white;
        }

        .tool-btn.danger {
            background: var(--danger);
            color: white;
        }

        /* Modals */
        .sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 400;
        }

        .sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 500;
            max-height: 70vh;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 5px;
            background: #c7c7cc;
            border-radius: 3px;
            margin: 0 auto 20px;
        }

        .sheet-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .status-opt {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .status-opt:active {
            transform: scale(0.95);
        }

        .status-opt.selected {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .status-opt .icon {
            font-size: 28px;
        }

        .sheet-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
        }

        .sheet-input:focus {
            border-color: var(--primary);
        }

        .sheet-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
        }

        .sheet-btn:active {
            transform: scale(0.98);
        }

        /* Admin Form */
        .admin-form {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .form-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .form-mode {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
            background: #f0f4ff;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 700;
            color: #8e8e93;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary);
        }

        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .role-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn.selected {
            border-color: var(--primary);
            background: #f0f4ff;
            color: var(--primary);
        }

        .form-actions {
            display: flex;
            gap: 10px;
        }

        .form-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .form-btn.primary {
            background: var(--primary);
            color: white;
        }

        .form-btn.secondary {
            background: #f2f2f7;
            color: #333;
        }

        .form-btn.danger {
            background: var(--danger);
            color: white;
        }

        /* User List */
        .user-list {
            background: white;
            border-radius: 16px;
            padding: 16px;
        }

        .user-list-header {
            font-size: 12px;
            font-weight: 700;
            color: #8e8e93;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-item:active {
            background: #f8f9ff;
            margin: 0 -16px;
            padding-left: 16px;
            padding-right: 16px;
        }

        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
            margin-bottom: 2px;
        }

        .user-item-pin {
            font-size: 12px;
            color: #8e8e93;
        }

        .user-item-role {
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-admin {
            background: #ffebee;
            color: #c62828;
        }

        .role-editor {
            background: #e3f2fd;
            color: #1565c0;
        }

        .role-reader {
            background: #f5f5f5;
            color: #616161;
        }

        .edit-hint {
            font-size: 11px;
            color: var(--primary);
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .user-item:hover .edit-hint {
            opacity: 1;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8e8e93;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 15px;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Login -->
    <div class="login-screen" id="loginScreen">
        <div class="water-bg"></div>
        <div class="login-logo">üõ°Ô∏è</div>
        <div class="login-title">–ö–æ–Ω—Ç—Ä–æ–ª—å –ü—Ä–æ—Ö–æ–¥—É</div>
        
        <div class="pin-container">
            <div class="water-fill" id="waterFill"></div>
            <div class="pin-display" id="pinDisplay">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            
            <div class="pin-keypad">
                <button class="pin-btn" onclick="addPin(1)">1</button>
                <button class="pin-btn" onclick="addPin(2)">2</button>
                <button class="pin-btn" onclick="addPin(3)">3</button>
                <button class="pin-btn" onclick="addPin(4)">4</button>
                <button class="pin-btn" onclick="addPin(5)">5</button>
                <button class="pin-btn" onclick="addPin(6)">6</button>
                <button class="pin-btn" onclick="addPin(7)">7</button>
                <button class="pin-btn" onclick="addPin(8)">8</button>
                <button class="pin-btn" onclick="addPin(9)">9</button>
                <button class="pin-btn clear" onclick="clearPin()">‚å´</button>
                <button class="pin-btn" onclick="addPin(0)">0</button>
                <button class="pin-btn enter" onclick="checkPin()">‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1>üè¢ –ü—Ä–æ—Ö—ñ–¥–Ω–∞</h1>
                <div class="datetime" id="currentTime">--:--</div>
            </div>
            <div class="user-badge">
                <span id="headerName">--</span>
                <span class="role-badge" id="headerRole">--</span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav" id="tabNav">
            <button class="tab-btn active" onclick="switchTab('personnel')">
                <span>üë•</span> –ü–µ—Ä—Å–æ–Ω–∞–ª
            </button>
            <button class="tab-btn" onclick="switchTab('stats')">
                <span>üìä</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
            <button class="tab-btn" onclick="switchTab('admin')">
                <span>‚öôÔ∏è</span> –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions" id="quickActions">
            <div class="action-btn" id="btn-in" onclick="applyQuickStatus('in', 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ')">
                <span class="action-icon">üè¢</span>
                <span class="action-label">–í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</span>
            </div>
            <div class="action-btn" id="btn-vz" onclick="applyQuickStatus('vz', 'üìû –í–ó')">
                <span class="action-icon">üìû</span>
                <span class="action-label">–í–ó</span>
            </div>
            <div class="action-btn" id="btn-rz" onclick="applyQuickStatus('rz', 'üìã –†–ó')">
                <span class="action-icon">üìã</span>
                <span class="action-label">–†–ó</span>
            </div>
            <div class="action-btn" id="btn-lunch" onclick="applyQuickStatus('lunch', 'üçΩÔ∏è –û–±—ñ–¥')">
                <span class="action-icon">üçΩÔ∏è</span>
                <span class="action-label">–û–±—ñ–¥</span>
            </div>
            <div class="action-btn" id="btn-custom" onclick="openCustomStatus()">
                <span class="action-icon">‚ö°</span>
                <span class="action-label">–Ü–Ω—à–µ</span>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-pill">
                <div class="stat-dot" style="background: #333;"></div>
                <span class="stat-label">–í—Å—å–æ–≥–æ</span>
                <span class="stat-num" id="statTotal">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--success);"></div>
                <span class="stat-label">–í –±—É–¥—ñ–≤–ª—ñ</span>
                <span class="stat-num" id="statIn">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--info);"></div>
                <span class="stat-label">–ù–∞ –í–ó</span>
                <span class="stat-num" id="statVz">0</span>
            </div>
            <div class="stat-pill">
                <div class="stat-dot" style="background: var(--danger);"></div>
                <span class="stat-label">–í—ñ–¥—Å—É—Ç–Ω—ñ</span>
                <span class="stat-num" id="statOut">0</span>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Personnel Tab -->
            <div class="tab-content active" id="tab-personnel">
                <div class="section-title">
                    <span>–ü–ï–†–°–û–ù–ê–õ</span>
                    <span class="selection-hint" id="selectionHint">–¢–∞–ø–∞–π—Ç–µ –¥–ª—è –≤–∏–±–æ—Ä—É</span>
                </div>
                <div class="person-grid" id="personGrid"></div>
            </div>

            <!-- Statistics Tab -->
            <div class="tab-content" id="tab-stats">
                <div class="stats-container" id="statsContainer"></div>
            </div>

            <!-- Admin Tab -->
            <div class="tab-content" id="tab-admin">
                <!-- Unified Form -->
                <div class="admin-form">
                    <div class="form-header">
                        <span class="form-title" id="formTitle">‚ûï –ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á</span>
                        <span class="form-mode" id="formMode">—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</span>
                    </div>
                    
                    <input type="hidden" id="editingUserPin">
                    
                    <label class="form-label">–ü–Ü–ë</label>
                    <input type="text" class="form-input" id="userName" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ">
                    
                    <label class="form-label">PIN (4 —Ü–∏—Ñ—Ä–∏)</label>
                    <input type="text" class="form-input" id="userPin" placeholder="1234" maxlength="4">
                    
                    <label class="form-label">–†–æ–ª—å</label>
                    <div class="role-selector">
                        <button class="role-btn selected" onclick="setRole('admin')" data-role="admin">üõ°Ô∏è –ê–¥–º—ñ–Ω</button>
                        <button class="role-btn" onclick="setRole('editor')" data-role="editor">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</button>
                        <button class="role-btn" onclick="setRole('reader')" data-role="reader">üëÅÔ∏è –ß–∏—Ç–∞—á</button>
                    </div>
                    
                    <div class="form-actions">
                        <button class="form-btn primary" onclick="saveUser()" id="saveBtn">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                        <button class="form-btn secondary hidden" onclick="cancelEdit()" id="cancelBtn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button class="form-btn danger hidden" onclick="deleteUser()" id="deleteBtn">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </div>
                </div>

                <!-- User List -->
                <div class="user-list">
                    <div class="user-list-header">üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Å–∏—Å—Ç–µ–º–∏</div>
                    <div id="adminList"></div>
                </div>

                <div style="padding: 20px;">
                    <button class="form-btn primary" onclick="exportData()" style="width: 100%; margin-bottom: 12px; background: #333;">üìä –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
                    <button class="form-btn danger" onclick="logout()" style="width: 100%;">üö™ –í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Toolbar -->
<div class="bottom-toolbar" id="toolbar">
    <button class="tool-btn danger" onclick="clearSelection()" title="–°–∫–∞—Å—É–≤–∞—Ç–∏">‚úï</button>
    <button class="tool-btn primary" onclick="openBulkSheet()" title="–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å">üìù</button>
    <span style="display: flex; align-items: center; padding: 0 8px; font-size: 14px; font-weight: 600; color: #333;" id="selectedCount">0</span>
</div>

<!-- Status Sheet -->
<div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="statusSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheetTitle">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</div>
    
    <div class="status-grid">
        <div class="status-opt" onclick="selectStatus('in', 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ')" style="background: #e8f5e9;">
            <span class="icon">üè¢</span>
            <span>–í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</span>
        </div>
        <div class="status-opt" onclick="selectStatus('vz', 'üìû –í–ó')" style="background: #e3f2fd;">
            <span class="icon">üìû</span>
            <span>–í–ó</span>
        </div>
        <div class="status-opt" onclick="selectStatus('rz', 'üìã –†–ó')" style="background: #fff3e0;">
            <span class="icon">üìã</span>
            <span>–†–ó</span>
        </div>
        <div class="status-opt" onclick="selectStatus('lunch', 'üçΩÔ∏è –û–±—ñ–¥')" style="background: #fce4ec;">
            <span class="icon">üçΩÔ∏è</span>
            <span>–û–±—ñ–¥</span>
        </div>
        <div class="status-opt" onclick="selectStatus('meeting', 'üë• –ù–∞—Ä–∞–¥–∞')" style="background: #f3e5f5;">
            <span class="icon">üë•</span>
            <span>–ù–∞—Ä–∞–¥–∞</span>
        </div>
        <div class="status-opt" onclick="selectStatus('home', 'üè† –î–æ–¥–æ–º—É')" style="background: #ffebee;">
            <span class="icon">üè†</span>
            <span>–î–æ–¥–æ–º—É</span>
        </div>
        <div class="status-opt" onclick="selectStatus('hospital', 'üè• –õ—ñ–∫–∞—Ä–Ω—è')" style="background: #e0f2f1;">
            <span class="icon">üè•</span>
            <span>–õ—ñ–∫–∞—Ä–Ω—è</span>
        </div>
        <div class="status-opt" onclick="selectStatus('trip', '‚úàÔ∏è –í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è')" style="background: #fff8e1;">
            <span class="icon">‚úàÔ∏è</span>
            <span>–í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è</span>
        </div>
    </div>

    <input type="text" class="sheet-input" id="sheetCustom" placeholder="–°–≤—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç...">
    <button class="sheet-btn" onclick="applyStatus()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–º—ñ–Ω–∏</button>
</div>

<!-- Custom Status Sheet -->
<div class="bottom-sheet" id="customStatusSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">‚ö° –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ç—É—Å</div>
    <input type="text" class="sheet-input" id="quickCustomInput" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å–≤—ñ–π —Å—Ç–∞—Ç—É—Å...">
    <button class="sheet-btn" onclick="applyQuickCustom()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–±—Ä–∞–Ω–∏—Ö</button>
</div>

<div class="toast" id="toast"></div>

<script>
// Data
let currentUser = null;
let currentPin = '';
let selectedRole = 'admin';
let selectedPersons = new Set();
let sheetTargets = [];
let sheetStatus = null;
let sheetText = '';
let editingUser = null;

// 11 Employees
let users = [
    { pin: '1111', name: '–®–µ–≤—á–µ–Ω–∫–æ –û.–ü.', role: 'admin' },
    { pin: '2222', name: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –ú.–Ü.', role: 'editor' },
    { pin: '3333', name: '–ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ –°.–ú.', role: 'reader' },
    { pin: '4444', name: '–¢–∫–∞—á–µ–Ω–∫–æ –ê.–í.', role: 'editor' },
    { pin: '5555', name: '–ú–µ–ª—å–Ω–∏–∫ –í.–û.', role: 'reader' }
];

// Simple status tracking - only current status with timestamp
let personnel = [
    { id: 1, name: '–®–µ–≤—á–µ–Ω–∫–æ –û.–ü.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', since: new Date(Date.now()-7200000).toISOString(), history: [] },
    { id: 2, name: '–ö–æ–≤–∞–ª–µ–Ω–∫–æ –ú.–Ü.', status: 'vz', statusText: 'üìû –í–ó', since: new Date(Date.now()-1800000).toISOString(), history: [] },
    { id: 3, name: '–ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ –°.–ú.', status: 'rz', statusText: 'üìã –†–ó', since: new Date(Date.now()-3600000).toISOString(), history: [] },
    { id: 4, name: '–¢–∫–∞—á–µ–Ω–∫–æ –ê.–í.', status: 'lunch', statusText: 'üçΩÔ∏è –û–±—ñ–¥', since: new Date(Date.now()-2700000).toISOString(), history: [] },
    { id: 5, name: '–ú–µ–ª—å–Ω–∏–∫ –í.–û.', status: 'meeting', statusText: 'üë• –ù–∞—Ä–∞–¥–∞', since: new Date(Date.now()-5400000).toISOString(), history: [] },
    { id: 6, name: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –Ü.–î.', status: 'home', statusText: 'üè† –î–æ–¥–æ–º—É', since: new Date(Date.now()-86400000).toISOString(), history: [] },
    { id: 7, name: '–°–∏–¥–æ—Ä–µ–Ω–∫–æ –ù.–ü.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', since: new Date(Date.now()-14400000).toISOString(), history: [] },
    { id: 8, name: '–ö—Ä–∞–≤—á–µ–Ω–∫–æ –û.–í.', status: 'vz', statusText: 'üìû –í–ó', since: new Date(Date.now()-4500000).toISOString(), history: [] },
    { id: 9, name: '–õ–∏—Å–µ–Ω–∫–æ –û.–ú.', status: 'in', statusText: 'üè¢ –í –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ', since: new Date(Date.now()-10800000).toISOString(), history: [] },
    { id: 10, name: '–ú–æ—Ä–æ–∑–æ–≤ –î.–°.', status: 'rz', statusText: 'üìã –†–ó', since: new Date(Date.now()-5400000).toISOString(), history: [] },
    { id: 11, name: '–í–∞—Å–∏–ª—å—î–≤–∞ –Ü.–ü.', status: 'lunch', statusText: 'üçΩÔ∏è –û–±—ñ–¥', since: new Date(Date.now()-1800000).toISOString(), history: [] }
];

// Clock
function updateTime() {
    const now = new Date();
    const el = document.getElementById('currentTime');
    if (el) el.textContent = now.toLocaleTimeString('uk-UA', {hour:'2-digit',minute:'2-digit'});
}
setInterval(updateTime, 1000);
updateTime();

// PIN Functions with colored dots
function addPin(num) {
    if (currentPin.length < 4) {
        currentPin += num;
        updatePin();
        const fill = document.getElementById('waterFill');
        if (fill) fill.style.height = (currentPin.length / 4 * 100) + '%';
    }
}

function clearPin() {
    currentPin = currentPin.slice(0, -1);
    updatePin();
    const fill = document.getElementById('waterFill');
    if (fill) fill.style.height = (currentPin.length / 4 * 100) + '%';
    const disp = document.getElementById('pinDisplay');
    if (disp) disp.classList.remove('error');
}

function updatePin() {
    const dots = document.querySelectorAll('.pin-dot');
    dots.forEach((dot, i) => {
        dot.classList.toggle('filled', i < currentPin.length);
    });
}

function checkPin() {
    if (currentPin.length !== 4) return;
    
    const user = users.find(u => u.pin === currentPin);
    if (user) {
        const disp = document.getElementById('pinDisplay');
        const fill = document.getElementById('waterFill');
        if (disp) disp.classList.add('success');
        if (fill) fill.style.height = '100%';
        
        setTimeout(() => {
            currentUser = user;
            
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const headerName = document.getElementById('headerName');
            const headerRole = document.getElementById('headerRole');
            const quickActions = document.getElementById('quickActions');
            const toolbar = document.getElementById('toolbar');
            
            if (loginScreen) loginScreen.style.display = 'none';
            if (mainApp) {
                mainApp.style.display = 'flex';
                mainApp.classList.add('active');
            }
            
            if (headerName) headerName.textContent = user.name.split(' ')[0];
            if (headerRole) headerRole.textContent = user.role;
            
            // Role-based visibility
            if (user.role === 'reader') {
                if (quickActions) quickActions.style.display = 'none';
                if (toolbar) toolbar.style.display = 'none';
                switchTab('stats');
            } else {
                if (quickActions) quickActions.style.display = 'grid';
                if (toolbar) toolbar.style.display = 'flex';
            }
            
            renderGrid();
            updateStats();
            renderStats();
            renderAdminList();
            
            currentPin = '';
            updatePin();
            if (fill) {
                fill.style.height = '0%';
                fill.style.background = '';
            }
            if (disp) disp.classList.remove('success');
            showToast('–í—ñ—Ç–∞—î–º–æ, ' + user.name.split(' ')[0] + '!');
        }, 400);
    } else {
        const disp = document.getElementById('pinDisplay');
        const fill = document.getElementById('waterFill');
        if (disp) disp.classList.add('error');
        if (fill) fill.style.background = 'rgba(255, 59, 48, 0.4)';
        
        setTimeout(() => {
            currentPin = '';
            updatePin();
            if (disp) disp.classList.remove('error');
            if (fill) {
                fill.style.height = '0%';
                fill.style.background = '';
            }
        }, 600);
    }
}

// Tab Switching
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(tab === 'personnel' ? '–ü–µ—Ä—Å–æ–Ω–∞–ª' : tab === 'stats' ? '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' : '–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è')) {
            btn.classList.add('active');
        }
    });
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById('tab-' + tab).classList.add('active');
    
    if (tab === 'stats') renderStats();
    if (tab === 'admin') renderAdminList();
}

// Quick Actions - Apply to ALL selected
function applyQuickStatus(status, text) {
    if (!currentUser || currentUser.role === 'reader') {
        showToast('‚õî –ù–µ–º–∞—î –ø—Ä–∞–≤');
        return;
    }
    
    const targets = selectedPersons.size > 0 ? Array.from(selectedPersons) : 
                   personnel.filter(p => p.name === currentUser.name).map(p => p.id);
    
    if (targets.length === 0) {
        showToast('‚õî –ù–µ–º–∞—î —Ü—ñ–ª–µ–π');
        return;
    }
    
    targets.forEach(id => {
        const person = personnel.find(p => p.id === id);
        if (person) changeStatus(person, status, text);
    });
    
    updateQuickButtons(status);
    showToast('‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ ' + targets.length + ' —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤');
    
    if (selectedPersons.size > 0) {
        clearSelection();
    }
}

function updateQuickButtons(activeStatus) {
    ['in', 'vz', 'rz', 'lunch'].forEach(s => {
        const btn = document.getElementById('btn-' + s);
        if (btn) btn.classList.toggle('active', s === activeStatus);
    });
}

function openCustomStatus() {
    if (!currentUser || currentUser.role === 'reader') {
        showToast('‚õî –ù–µ–º–∞—î –ø—Ä–∞–≤');
        return;
    }
    
    const overlay = document.getElementById('sheetOverlay');
    const sheet = document.getElementById('customStatusSheet');
    const input = document.getElementById('quickCustomInput');
    
    if (overlay) overlay.classList.add('active');
    if (sheet) sheet.classList.add('active');
    if (input) {
        input.value = '';
        setTimeout(() => input.focus(), 100);
    }
}

function applyQuickCustom() {
    const input = document.getElementById('quickCustomInput');
    const text = input ? input.value.trim() : '';
    
    if (!text) {
        showToast('‚õî –í–≤–µ–¥—ñ—Ç—å —Å—Ç–∞—Ç—É—Å');
        return;
    }
    
    applyQuickStatus('custom', '‚ö° ' + text);
    closeSheet();
}

// Status Management - Simple: just current status
function changeStatus(person, status, text) {
    // Save to history (optional, for stats)
    if (!person.history) person.history = [];
    person.history.push({
        from: person.statusText,
        to: text,
        time: new Date().toISOString()
    });
    
    person.status = status;
    person.statusText = text;
    person.since = new Date().toISOString();
    
    renderGrid();
    updateStats();
}

function getColor(s) {
    const c = {in:'#34c759', vz:'#007aff', rz:'#ff9500', lunch:'#ff9500', meeting:'#af52de', home:'#ff3b30', out:'#999', custom:'#667eea'};
    return c[s] || '#999';
}

function calcDuration(since) {
    const d = new Date() - new Date(since);
    const h = Math.floor(d/3600000), m = Math.floor((d%3600000)/60000);
    if (h > 0) return h + '–≥ ' + m + '—Ö–≤';
    return m + '—Ö–≤';
}

// Grid Rendering
function renderGrid() {
    const grid = document.getElementById('personGrid');
    const hint = document.getElementById('selectionHint');
    
    if (!grid) return;
    grid.innerHTML = '';
    
    if (hint) hint.classList.toggle('visible', selectedPersons.size > 0);
    
    const isReader = !currentUser || currentUser.role === 'reader';
    
    personnel.forEach(p => {
        const isSel = selectedPersons.has(p.id);
        const duration = calcDuration(p.since);
        
        const card = document.createElement('div');
        card.className = 'person-card ' + (isSel ? 'selected' : '');
        
        card.onclick = function(e) {
            if (isReader) return;
            toggleSelect(p.id);
        };
        
        card.ondblclick = function(e) {
            if (isReader) return;
            if (selectedPersons.size === 0) {
                openSheet([p.id]);
            }
        };
        
        card.innerHTML = 
            '<div class="person-header">' +
                '<div class="person-avatar">' + p.name.charAt(0) + '</div>' +
                '<div class="person-info">' +
                    '<div class="person-name">' + p.name + '</div>' +
                    '<div class="person-time">' + duration + '</div>' +
                '</div>' +
            '</div>' +
            '<span class="status-badge" style="background:' + getColor(p.status) + ';">' + p.statusText + '</span>';
        
        grid.appendChild(card);
    });
}

function toggleSelect(id) {
    if (selectedPersons.has(id)) {
        selectedPersons.delete(id);
    } else {
        selectedPersons.add(id);
    }
    updateSelUI();
    renderGrid();
}

function updateSelUI() {
    const n = selectedPersons.size;
    const toolbar = document.getElementById('toolbar');
    const count = document.getElementById('selectedCount');
    
    if (toolbar) toolbar.classList.toggle('visible', n > 0);
    if (count) count.textContent = n;
}

function clearSelection() {
    selectedPersons.clear();
    updateSelUI();
    renderGrid();
}

function updateStats() {
    const total = document.getElementById('statTotal');
    const statIn = document.getElementById('statIn');
    const statVz = document.getElementById('statVz');
    const statOut = document.getElementById('statOut');
    
    if (total) total.textContent = personnel.length;
    if (statIn) statIn.textContent = personnel.filter(p => p.status === 'in').length;
    if (statVz) statVz.textContent = personnel.filter(p => p.status === 'vz').length;
    if (statOut) statOut.textContent = personnel.filter(p => ['home','out','hospital','trip'].includes(p.status)).length;
}

// Statistics Tab - Simple overview
function renderStats() {
    const container = document.getElementById('statsContainer');
    if (!container) return;
    
    // Group by status
    const byStatus = {};
    personnel.forEach(p => {
        if (!byStatus[p.statusText]) byStatus[p.statusText] = [];
        byStatus[p.statusText].push(p);
    });
    
    // Calculate average duration per status
    let html = '<div style="display: grid; gap: 12px;">';
    
    // Summary card
    html += `
        <div style="background: white; border-radius: 16px; padding: 16px;">
            <div style="font-size: 14px; font-weight: 700; color: #666; margin-bottom: 12px; text-transform: uppercase;">üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 12px;">
                    <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${personnel.length}</div>
                    <div style="font-size: 12px; color: #666;">–í—Å—å–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤</div>
                </div>
                <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 12px;">
                    <div style="font-size: 28px; font-weight: 700; color: var(--success);">${personnel.filter(p => p.status === 'in').length}</div>
                    <div style="font-size: 12px; color: #666;">–ó–∞—Ä–∞–∑ –≤ –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—ñ</div>
                </div>
            </div>
        </div>
    `;
    
    // By status
    Object.entries(byStatus).forEach(([status, people]) => {
        const avgDur = people.reduce((sum, p) => sum + (new Date() - new Date(p.since)), 0) / people.length;
        const avgH = Math.floor(avgDur / 3600000);
        const avgM = Math.floor((avgDur % 3600000) / 60000);
        
        html += `
            <div style="background: white; border-radius: 16px; padding: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-weight: 600; font-size: 16px;">${status}</span>
                    <span style="background: ${getColor(people[0].status)}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${people.length}</span>
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 8px;">–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å: ${avgH}–≥ ${avgM}—Ö–≤</div>
                <div style="font-size: 12px; color: #999;">
                    ${people.map(p => p.name.split(' ')[0]).join(', ')}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Sheets
function openSheet(ids) {
    sheetTargets = ids;
    const title = document.getElementById('sheetTitle');
    const overlay = document.getElementById('sheetOverlay');
    const sheet = document.getElementById('statusSheet');
    
    if (title) title.textContent = ids.length === 1 ? '–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å' : '–ó–º—ñ–Ω–∏—Ç–∏ (' + ids.length + ') —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤';
    if (overlay) overlay.classList.add('active');
    if (sheet) sheet.classList.add('active');
    
    document.querySelectorAll('#statusSheet .status-opt').forEach(el => el.classList.remove('selected'));
    const custom = document.getElementById('sheetCustom');
    if (custom) custom.value = '';
    sheetStatus = null;
}

function openBulkSheet() {
    openSheet(Array.from(selectedPersons));
}

function closeSheet() {
    const overlay = document.getElementById('sheetOverlay');
    const statusSheet = document.getElementById('statusSheet');
    const customSheet = document.getElementById('customStatusSheet');
    
    if (overlay) overlay.classList.remove('active');
    if (statusSheet) statusSheet.classList.remove('active');
    if (customSheet) customSheet.classList.remove('active');
}

function selectStatus(st, txt) {
    document.querySelectorAll('#statusSheet .status-opt').forEach(el => el.classList.remove('selected'));
    if (event && event.currentTarget) event.currentTarget.classList.add('selected');
    sheetStatus = st;
    sheetText = txt;
    const custom = document.getElementById('sheetCustom');
    if (custom) custom.value = '';
}

function applyStatus() {
    const customEl = document.getElementById('sheetCustom');
    const cst = customEl ? customEl.value.trim() : '';
    const st = cst ? 'custom' : sheetStatus;
    const txt = cst ? '‚ö° ' + cst : sheetText;
    
    if (!st) {
        showToast('‚õî –û–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—É—Å');
        return;
    }
    
    sheetTargets.forEach(id => {
        const p = personnel.find(x => x.id === id);
        if (p) changeStatus(p, st, txt);
    });
    
    showToast('‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ ' + sheetTargets.length + ' —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤!');
    closeSheet();
    clearSelection();
}

// Unified Admin Form
function setRole(role) {
    selectedRole = role;
    document.querySelectorAll('.role-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.role === role);
    });
}

function editUser(pin) {
    const user = users.find(u => u.pin === pin);
    if (!user) return;
    
    editingUser = user;
    
    document.getElementById('userName').value = user.name;
    document.getElementById('userPin').value = user.pin;
    document.getElementById('editingUserPin').value = user.pin;
    
    setRole(user.role);
    
    document.getElementById('formTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è';
    document.getElementById('formMode').textContent = '—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è';
    document.getElementById('saveBtn').textContent = 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏';
    document.getElementById('cancelBtn').classList.remove('hidden');
    
    if (user.pin === currentUser.pin) {
        document.getElementById('deleteBtn').classList.add('hidden');
    } else {
        document.getElementById('deleteBtn').classList.remove('hidden');
    }
    
    showToast('‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è');
}

function cancelEdit() {
    editingUser = null;
    
    document.getElementById('userName').value = '';
    document.getElementById('userPin').value = '';
    document.getElementById('editingUserPin').value = '';
    
    document.getElementById('formTitle').textContent = '‚ûï –ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á';
    document.getElementById('formMode').textContent = '—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è';
    document.getElementById('saveBtn').textContent = '‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏';
    document.getElementById('cancelBtn').classList.add('hidden');
    document.getElementById('deleteBtn').classList.add('hidden');
    
    setRole('admin');
}

function saveUser() {
    const name = document.getElementById('userName').value.trim();
    const pin = document.getElementById('userPin').value.trim();
    const oldPin = document.getElementById('editingUserPin').value;
    
    if (!name || pin.length !== 4) {
        showToast('‚õî –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ');
        return;
    }
    
    if (editingUser) {
        if (pin !== oldPin && users.find(u => u.pin === pin)) {
            showToast('‚õî –ù–æ–≤–∏–π PIN –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π');
            return;
        }
        
        const userIndex = users.findIndex(u => u.pin === oldPin);
        if (userIndex !== -1) {
            users[userIndex] = { pin: pin, name: name, role: selectedRole };
            
            if (currentUser.pin === oldPin) {
                currentUser = users[userIndex];
                document.getElementById('headerName').textContent = name.split(' ')[0];
                document.getElementById('headerRole').textContent = selectedRole;
            }
            
            showToast('‚úÖ –ó–º—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
            cancelEdit();
            renderAdminList();
        }
    } else {
        if (users.find(u => u.pin === pin)) {
            showToast('‚õî PIN –≤–∂–µ —ñ—Å–Ω—É—î');
            return;
        }
        
        users.push({ pin: pin, name: name, role: selectedRole });
        showToast('‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Å—Ç–≤–æ—Ä–µ–Ω–æ!');
        
        document.getElementById('userName').value = '';
        document.getElementById('userPin').value = '';
        setRole('admin');
        
        renderAdminList();
    }
}

function deleteUser() {
    if (!editingUser) return;
    
    if (editingUser.pin === currentUser.pin) {
        showToast('‚õî –ù–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å–µ–±–µ');
        return;
    }
    
    if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ' + editingUser.name + '?')) {
        users = users.filter(u => u.pin !== editingUser.pin);
        showToast('üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ');
        cancelEdit();
        renderAdminList();
    }
}

function renderAdminList() {
    const container = document.getElementById('adminList');
    if (!container) return;
    
    container.innerHTML = users.map(u => {
        const roleClass = u.role;
        return `
            <div class="user-item" onclick="editUser('${u.pin}')">
                <div class="user-item-info">
                    <div class="user-item-name">${u.name} <span class="edit-hint">‚úèÔ∏è —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏</span></div>
                    <div class="user-item-pin">PIN: ${u.pin}</div>
                </div>
                <span class="user-item-role role-${roleClass}">${u.role}</span>
            </div>
        `;
    }).join('');
}

function exportData() {
    let csv = '–ü–Ü–ë,–°—Ç–∞—Ç—É—Å,–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å—É\n';
    personnel.forEach(p => {
        const dur = calcDuration(p.since);
        csv += `"${p.name}","${p.statusText}","${dur}"\n`;
    });
    const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '–ø—Ä–æ—Ö–æ–¥_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    showToast('üìä –ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
}

function logout() {
    currentUser = null;
    selectedPersons.clear();
    
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('mainApp').classList.remove('active');
    document.getElementById('toolbar').classList.remove('visible');
    
    document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === 0);
    });
    document.querySelectorAll('.tab-content').forEach((content, i) => {
        content.classList.toggle('active', i === 0);
    });
    
    cancelEdit();
    
    currentPin = '';
    updatePin();
    const fill = document.getElementById('waterFill');
    if (fill) fill.style.height = '0%';
}

function showToast(m) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.textContent = m;
    t.classList.add('show');
    setTimeout(function() {
        t.classList.remove('show');
    }, 2500);
}

// Touch handling
let touchStartY = 0;
document.addEventListener('touchstart', function(e) {
    touchStartY = e.touches[0].clientY;
});
document.addEventListener('touchmove', function(e) {
    const diff = e.touches[0].clientY - touchStartY;
    if (diff > 100) {
        const sheet = document.querySelector('.bottom-sheet.active');
        if (sheet) closeSheet();
    }
});

// Init
renderGrid();
updateStats();
</script>

</body>
</html>
